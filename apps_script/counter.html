<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Advanced POS Counter Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
:root {
  --bg:#0b0b0b;
  --card:#111;
  --text:#f9fafb;
  --muted:#a3a3a3;
  --line:#222;
  --accent:#2563eb;
  --accent-soft:#1d4ed8;
  --accent-text:#e5f0ff;
  --pending:#fde68a;
  --paid:#a7f3d0;
  --warning:#fef3c7;
  --error:#fecaca;
  --success:#bbf7d0;
  --success-bg:#14532d;

  /* Font controls - Changed to points for better print consistency */
  --font-main: 9pt;
  --font-shop-name: 10pt;
  --font-title: 12pt;
  --font-item: 8pt;
  --font-total: 11pt;
  --font-footer: 7pt;
}

*{box-sizing:border-box;}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,Segoe UI,Arial,sans-serif;
}
body{display:flex;flex-direction:column;}

/* FIXED HEADER LAYOUT */
header{
  position:sticky;top:0;z-index:20;
  background:#101010;
  border-bottom:1px solid var(--line);
  padding:16px 20px;
}
.header-main{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:20px;
  margin-bottom:16px;
}
.header-title h1{
  margin:0;font-size:24px;font-weight:600;
}
.header-title .sub{
  margin-top:6px;font-size:14px;color:var(--muted);
}

.header-controls{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:12px;
}
.bar-top{
  display:flex;flex-wrap:wrap;
  align-items:center;gap:12px;
}

.badge{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:80px;padding:6px 12px;
  border-radius:999px;font-size:13px;
  background:#111;border:1px solid var(--line);color:var(--muted);
}
.badge strong{margin-left:6px;color:var(--text);}
.badge.orders{background:#111;border-color:#1f2937;}
.badge.items{background:rgba(234,179,8,0.18);border-color:#eab308;color:#facc15;}
.badge.amount{background:rgba(34,197,94,0.16);border-color:#22c55e;color:#bbf7d0;}
.badge.paid{background:rgba(59,130,246,0.15);border-color:#3b82f6;color:#bfdbfe;}
.badge.pending{background:rgba(248,250,252,0.06);border-color:#4b5563;color:#e5e7eb;}
.badge.new{background:rgba(129,140,248,0.16);border-color:#818cf8;color:#c7d2fe;}

.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 14px;border-radius:999px;
  font-size:13px;border:1px solid var(--line);
  background:#111;color:var(--muted);cursor:pointer;
  transition:all 0.2s ease;
}
.pill:hover{background:#1a1a1a;}
.pill.active{
  background:var(--accent-soft);
  border-color:var(--accent);
  color:var(--accent-text);
}
.pill input{margin:0;margin-right:6px;}

.btn{
  border:none;border-radius:999px;
  padding:10px 16px;font-size:14px;
  background:#111;border:1px solid var(--line);
  color:var(--text);cursor:pointer;
  display:inline-flex;align-items:center;gap:6px;
  transition:all 0.2s ease;
}
.btn:hover:not(:disabled){
  transform:translateY(-1px);
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.btn.primary{
  background:var(--accent-soft);
  border-color:var(--accent);
  color:var(--accent-text);
}
.btn.danger{
  background:#7f1d1d;border-color:#b91c1c;color:#fecaca;
}
.btn.small{padding:8px 12px;font-size:13px;}
.btn:disabled{opacity:.45;cursor:default;}
.btn-group{display:flex;flex-wrap:wrap;gap:10px;}

.date-nav{
  display:inline-flex;align-items:center;gap:6px;
}
.date-nav button{
  border-radius:999px;border:1px solid var(--line);
  background:#111;color:#fff;
  width:32px;height:32px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.date-nav button:hover:not(:disabled){background:#1a1a1a;}
.date-nav input{
  background:#020617;border:1px solid var(--line);
  border-radius:999px;color:#e5e7eb;
  padding:6px 12px;font-size:13px;
  min-width:140px;text-align:center;
}

/* custom range date inputs (for Range Report) */
.range-nav{
  display:inline-flex;
  align-items:center;
  gap:4px;
  margin-left:8px;
  font-size:12px;
  color:var(--muted);
}
.range-nav input{
  background:#020617;border:1px solid var(--line);
  border-radius:999px;color:#e5e7eb;
  padding:4px 8px;font-size:12px;
  min-width:115px;
}
.range-nav span{padding:0 4px;}

main{
  flex:1;
  overflow:auto;
  padding:20px;
}
.table-wrap{
  max-width:none;
  margin:0 auto;
  border-radius:12px;
  overflow:hidden;
  background:radial-gradient(circle at top,#0f172a 0,#020617 45%,#020617 100%);
  border:1px solid #1f2937;
  overflow-x:auto;
}

table{
  width:100%;border-collapse:collapse;
  font-size:14px;min-width:1200px;
}
thead{background:#020617;}
th,td{
  padding:12px 16px;
  border-bottom:1px solid #111;
  white-space:nowrap;
}
th{
  font-weight:600;color:#e5e7eb;
  text-align:left;font-size:13px;
  background:#0f172a;
}
tbody tr:nth-child(even),
tbody tr:nth-child(odd){background:#020617;}
tbody tr:hover{background:#0b1120;}

td.time{
  font-feature-settings:"tnum" 1;
  font-variant-numeric:tabular-nums;
  min-width:80px;
}
td.price{
  text-align:right;
  font-feature-settings:"tnum" 1;
  font-variant-numeric:tabular-nums;
  min-width:100px;
}

th:nth-child(1), td:nth-child(1){width:50px;}
th:nth-child(2), td:nth-child(2){width:90px;}
th:nth-child(3), td:nth-child(3){width:120px;}
th:nth-child(4), td:nth-child(4){min-width:200px;}
th:nth-child(5), td:nth-child(5){width:120px;}
th:nth-child(6), td:nth-child(6){width:120px;}
th:nth-child(7), td:nth-child(7){width:100px;}
th:nth-child(8), td:nth-child(8){width:100px;}
th:nth-child(9), td:nth-child(9){min-width:150px;}
th:nth-child(10),td:nth-child(10){width:120px;}
th:nth-child(11),td:nth-child(11){width:100px;}

.status-pill{
  display:inline-flex;align-items:center;justify-content:center;
  padding:4px 10px;border-radius:999px;font-size:12px;
  min-width:70px;
}
.status-unpaid{background:rgba(250,204,21,0.12);color:#facc15;}
.status-paid{background:rgba(22,163,74,0.14);color:#bbf7d0;}
.row-selected{box-shadow:inset 0 0 0 1px #38bdf8;background:#0f172a!important;}

/* Toast */
.toast{
  position:fixed;top:20px;right:20px;
  padding:12px 16px;border-radius:8px;
  color:#fff;font-size:14px;z-index:1000;
  max-width:300px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
  transform:translateX(400px);
  transition:transform 0.3s ease;
}
.toast.show{transform:translateX(0);}
.toast.error{background:#dc2626;}
.toast.success{background:#16a34a;}
.toast.warning{background:#d97706;}
.toast.info{background:#2563eb;}

/* Login overlay */
#loginOverlay{
  position:fixed;inset:0;z-index:50;
  background:rgba(15,23,42,0.92);
  display:flex;align-items:center;justify-content:center;
}
.login-box{
  background:#020617;border-radius:16px;
  padding:32px;min-width:320px;
  border:1px solid #1f2937;
  box-shadow:0 10px 25px rgba(0,0,0,0.5);
}
.login-box h2{
  margin:0 0 20px;font-size:24px;
  text-align:center;font-weight:600;
}
.login-box label{
  font-size:14px;color:#e5e7eb;
  margin-top:16px;display:block;font-weight:500;
}
.login-box input{
  width:100%;margin-top:8px;padding:12px 16px;
  border-radius:10px;border:1px solid #1f2937;
  background:#020617;color:#e5e7eb;font-size:14px;
}
.login-box input:focus{
  outline:none;border-color:#3b82f6;
}
.login-box button{
  margin-top:24px;width:100%;
  border:none;border-radius:999px;
  padding:12px 0;background:var(--accent-soft);
  color:var(--accent-text);cursor:pointer;
  font-size:14px;font-weight:600;
}
.login-box button:hover{background:var(--accent);}
.login-error{
  margin-top:8px;font-size:13px;
  color:#fecaca;min-height:20px;text-align:center;
}
.login-info{
  margin-top:16px;font-size:12px;
  color:var(--muted);text-align:center;line-height:1.4;
}

/* Checkout modal */
.co-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(4px);
  z-index:80;
}
//checkout screen size can edit
.co-modal {
  position: fixed;
  inset: 0;
  margin: auto;

  width: 850px !important;        /* â† ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã«ãƒ¯ã‚¤ãƒ‰åŒ– */
  max-width: 95vw !important;     /* â† ç”»é¢ã®95%ã¾ã§åºƒã’ã‚‹ */

  background: #ffffff !important;
  color: #0f172a !important;
  border-radius: 24px !important;
  box-shadow: 0 18px 45px rgba(0,0,0,0.5);
  padding: 28px 32px !important;
  z-index: 90;
}

.co-modal.hidden,.co-backdrop.hidden{display:none;}

.co-header{
  display:flex;align-items:flex-start;
  justify-content:space-between;gap:12px;
  margin-bottom:12px;
}
.co-header h2{margin:0;font-size:18px;}
.co-sub{margin:2px 0 0;font-size:11px;color:#9ca3af;}
.co-close-btn{
  border:none;background:transparent;
  color:#9ca3af;font-size:20px;
  cursor:pointer;line-height:1;
}
.co-body{
  border-top:1px solid #111827;
  border-bottom:1px solid #111827;
  padding:10px 0 12px;
  display:flex;flex-direction:column;gap:12px;
}
.co-row{
  display:flex;align-items:center;
  justify-content:space-between;font-size:13px;
}
.co-row-total{
  margin-top:4px;padding-top:8px;
  border-top:1px dashed #1f2933;
}
.co-value{font-variant-numeric:tabular-nums;}
.co-value.strong{font-weight:600;font-size:14px;}

.co-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.co-field{display:flex;flex-direction:column;gap:4px;}
.co-field.full-width{grid-column:1/-1;}
.co-field label{font-size:11px;color:#9ca3af;}
.co-field input,.co-field select{
  font-size:13px;padding:6px 8px;
  border-radius:8px;border:1px solid #1f2937;
  background:#020617;color:#e5e7eb;outline:none;
}
.co-field input:focus,
.co-field select:focus{
  border-color:#2563eb;
  box-shadow:0 0 0 1px rgba(37,99,235,.4);
}
.co-footer{
  display:flex;justify-content:flex-end;
  gap:8px;margin-top:12px;
}
.co-btn{
  border-radius:999px;font-size:13px;
  padding:6px 14px;border:1px solid.transparent;
  cursor:pointer;
}
.co-btn.ghost{
  background:transparent;color:#e5e7eb;
  border-color:#374151;
}
.co-btn.ghost:hover{background:#111827;}
.co-btn.primary{background:#2563eb;color:#f9fafb;}
.co-btn.primary:hover{background:#1d4ed8;}

/* ===== RECEIPT PREVIEW (æ—¥æœ¬èªï¼‹è‹±èªãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰) ===== */
#receiptArea{
  display:none;
  position:fixed;inset:0;
  padding:12mm;
  background:#020617;color:#e5e7eb;
  z-index:70;overflow:auto;box-sizing:border-box;
  font-size:var(--font-main);
}

/* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã¯ç”»é¢ã§ã ã‘è¡¨ç¤ºï¼ˆå°åˆ·ã¯@media printã§éè¡¨ç¤ºï¼‰ */
.receipt-close-btn{
  position:absolute;top:16px;right:16px;z-index:80;
  border-radius:999px;background:#111827;
  color:#e5e7eb;border:1px solid #4b5563;
  padding:6px 12px;font-size:12px;cursor:pointer;
}
.receipt-close-btn:hover{background:#1f2937;}

/* ãƒ¬ã‚·ãƒ¼ãƒˆæœ¬ä½“ */
.receipt-box{
  max-width:80mm;
  margin:0 auto 8mm;
  background:#ffffff;
  color:#111827;
  padding:8mm 6mm;
  border-radius:6px;
  box-shadow:0 6px 20px rgba(0,0,0,.4);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  font-size:var(--font-main);
  line-height:1.4;
}

/* åº—åãƒ–ãƒ­ãƒƒã‚¯ */
.receipt-header{
  text-align:center;
  margin-bottom:5mm;
}
.receipt-header .shop-name{
  font-size:var(--font-shop-name);
  font-weight:700;
}
.receipt-header .shop-sub{
  font-size:calc(var(--font-main) - 1pt);
  margin-top:2px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ï¼šãƒ¬ã‚·ãƒ¼ãƒˆ / RECEIPT */
.receipt-title{
  text-align:center;
  font-weight:700;
  margin-bottom:3mm;
  font-size:var(--font-title);
}

/* æ—¥ä»˜ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ã®è¡Œ */
.receipt-row{
  display:flex;
  justify-content:space-between;
  margin:1mm 0;
  font-variant-numeric:tabular-nums;
}
.receipt-row span{
  font-size:var(--font-main);
}
.receipt-row.total{
  border-top:1px solid #111827;
  margin-top:2mm;
  padding-top:2mm;
  font-weight:700;
  font-size:var(--font-total);
}

/* ä»•åˆ‡ã‚Šç·š */
.receipt-separator{
  border-top:1px dashed #d1d5db;
  margin:2mm 0;
}

/* å•†å“ä¸€è¦§ */
.receipt-items{
  border-top:1px solid #e5e7eb;
  border-bottom:1px solid #e5e7eb;
  margin:2mm 0;
  padding:2mm 0;
}
.receipt-item-line{
  display:flex;
  justify-content:space-between;
  margin:0.5mm 0;
  font-size:var(--font-item);
}
.receipt-item-line-name{
  max-width:40mm;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}

/* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ—¥è‹±ï¼‰ */
.receipt-footer{
  margin-top:4mm;
  text-align:center;
  font-size:var(--font-footer);
  line-height:1.4;
}

.formal-block{margin:2mm 0;font-size:9pt;}
.formal-amount{
  font-size:12pt;font-weight:600;
  text-align:right;margin-top:2mm;
}
.formal-stamp{
  margin-top:4mm;text-align:right;font-size:8pt;
}

.loading{
  display:inline-block;width:16px;height:16px;
  border:2px solid rgba(255,255,255,0.3);
  border-radius:50%;border-top-color:#fff;
  animation:spin 1s ease-in-out infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* Reprint System Styles */
.reprint-order-item {
  padding:12px;
  margin:8px 0;
  border:1px solid #374151;
  border-radius:8px;
  cursor:pointer;
  transition:all 0.2s ease;
  background:#111827;
}

.reprint-order-item:hover {
  border-color:#6b7280;
  background:#1f2937;
  transform:translateY(-1px);
}

.reprint-order-item.selected {
  border-color:#3b82f6;
  background:#1e3a8a;
  box-shadow:0 0 0 2px rgba(59,130,246,0.5);
}

.reprint-order-item.unpaid {
  background:#1f1b1b;
  border-color:#7f1d1d;
  color:#9ca3af;
  cursor:not-allowed;
  opacity:0.7;
}

.reprint-order-item.unpaid:hover {
  background:#1f1b1b;
  border-color:#7f1d1d;
  transform:none;
}

.reprint-checkbox {
  margin-right:12px;
  transform:scale(1.2);
}

.reprint-checkbox:disabled {
  opacity:0.5;
  cursor:not-allowed;
}

#reprint-orders-list {
  max-height:300px;
  overflow-y:auto;
  scrollbar-width:thin;
  scrollbar-color:#4b5563 #111827;
}

#reprint-orders-list::-webkit-scrollbar {
  width:6px;
}

#reprint-orders-list::-webkit-scrollbar-track {
  background:#111827;
  border-radius:3px;
}

#reprint-orders-list::-webkit-scrollbar-thumb {
  background:#4b5563;
  border-radius:3px;
}

#reprint-orders-list::-webkit-scrollbar-thumb:hover {
  background:#6b7280;
}

.warning-message {
  background:rgba(234,179,8,0.1);
  border:1px solid rgba(234,179,8,0.3);
  border-radius:6px;
  padding:10px 12px;
  margin:12px 0;
  font-size:12px;
  color:#facc15;
  display:flex;
  align-items:center;
  gap:8px;
}

.warning-message::before {
  content:"âš ";
  font-size:14px;
}

/* Paid order styling in checkout mode */
.paid-order-disabled {
  opacity:0.6;
  cursor:not-allowed !important;
}

.paid-order-disabled:hover {
  background:#020617 !important;
}

.paid-order-disabled td:first-child input[disabled] {
  cursor:not-allowed;
}

.reference-number-display {
  background:#f3f4f6;
  border:1px dashed #d1d5db;
  border-radius:4px;
  padding:6px;
  margin:8px 0;
  text-align:center;
}

.reference-number-label {
  font-size:10px;
  color:#6b7280;
}

.reference-number-value {
  font-family:monospace;
  font-size:12px;
  font-weight:600;
  color:#111827;
}

/* Reprint modal improvements */
#reprint-modal .co-body {
  max-height:70vh;
  overflow-y:auto;
}

#reprint-results {
  margin-top:16px;
  border-top:1px solid #1f2937;
  padding-top:12px;
}

.reference-number-badge {
  background:#1e40af;
  color:white;
  padding:2px 8px;
  border-radius:4px;
  font-size:11px;
  font-family:monospace;
  margin-left:8px;
}

/* Status indicators */
.status-indicator {
  display:inline-block;
  width:8px;
  height:8px;
  border-radius:50%;
  margin-right:6px;
}

.status-paid .status-indicator {
  background:#10b981;
}

.status-unpaid .status-indicator {
  background:#f59e0b;
}

/* Bluetooth printing styles */
.btn.bluetooth {
  background:#1e40af;
  border-color:#3b82f6;
  color:#bfdbfe;
}

.btn.bluetooth.connected {
  background:#14532d;
  border-color:#22c55e;
  color:#bbf7d0;
  animation:pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity:1; }
  50% { opacity:0.7; }
  100% { opacity:1; }
}

.btn.auto-print {
  background:#7c2d12;
  border-color:#ea580c;
  color:#fed7aa;
}

.btn.auto-print.active {
  background:#166534;
  border-color:#22c55e;
  color:#bbf7d0;
}

/* Bluetooth status indicator */
.bluetooth-status {
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  background:#111827;
  border:1px solid #374151;
}

.bluetooth-status.connected {
  background:rgba(34,197,94,0.1);
  border-color:#22c55e;
  color:#bbf7d0;
}

.bluetooth-status.disconnected {
  background:rgba(239,68,68,0.1);
  border-color:#ef4444;
  color:#fecaca;
}

/* Print button in receipt area */
.receipt-bluetooth-btn {
  position:absolute;
  top:16px;
  left:16px;
  z-index:80;
  border-radius:999px;
  background:#1e40af;
  color:#bfdbfe;
  border:1px solid #3b82f6;
  padding:6px 12px;
  font-size:12px;
  cursor:pointer;
}

.receipt-bluetooth-btn:hover {
  background:#1d4ed8;
}

@media (max-width:1200px){
  .header-main{flex-direction:column;align-items:stretch;}
  .header-controls{align-items:stretch;}
  .bar-top{justify-content:space-between;}
}
@media (max-width:768px){
  header{padding:12px 16px;}
  .header-title h1{font-size:20px;}
  .bar-top{flex-direction:column;align-items:stretch;gap:8px;}
  .btn-group{justify-content:space-between;width:100%;}
  .btn-group .btn{flex:1;min-width:auto;}
  .date-nav{justify-content:center;margin-top:8px;}
  main{padding:16px;}
  .table-wrap{border-radius:8px;}
  th,td{padding:10px 12px;font-size:13px;}
  .badge{min-width:70px;padding:5px 10px;font-size:12px;}
  .pill{padding:6px 12px;font-size:12px;}
  .btn{padding:8px 12px;font-size:13px;}
  .co-modal{width:95vw;padding:16px;}
  .co-grid{grid-template-columns:1fr;}
  #reprint-modal{width:95vw;}
}

/* ============================
   å…±é€šï¼šå°åˆ·æ™‚ã®åŸºæœ¬è¨­å®š
   ============================ */
@media print {
  /* ãƒ¬ã‚·ãƒ¼ãƒˆä»¥å¤–ã¯éè¡¨ç¤º */
  header,
  main,
  #loginOverlay,
  #checkout-backdrop,
  #checkout-modal,
  #reprint-backdrop,
  #reprint-modal,
  .toast,
  .receipt-close-btn,
  .receipt-bluetooth-btn,
  .receipt-toolbar {
    display: none !important;
  }

  html,
  body {
    margin: 0 !important;
    padding: 0 !important;
    background: #ffffff !important;
    color: #000000 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* ãƒ¬ã‚·ãƒ¼ãƒˆé ˜åŸŸï¼šå¹… 58mm ã§ä¸­å¤®å¯„ã› */
  #receiptArea {
    display: block !important;
    position: static !important;
    width: 58mm !important;
    max-width: 58mm !important;
    margin: 0 auto !important;
    padding: 0 !important;
    background: #ffffff !important;
    color: #000000 !important;
    overflow: visible !important;
    box-shadow: none !important;
  }

  .receipt-box {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important;
    padding: 4mm 3mm !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    background: #ffffff !important;
    color: #000000 !important;
    line-height: 1.3 !important;
    border: none !important;
    page-break-inside: avoid !important;
  }

  /* ã“ã“ã§ã¯å¤‰æ•°ã ã‘ã‚’ä½¿ã†ã€‚pt ã‚„ !important ã§å›ºå®šã—ãªã„ */
  .receipt-header .shop-name { font-size: var(--font-shop-name); }
  .receipt-title              { font-size: var(--font-title); }
  .receipt-item-line          { font-size: var(--font-item); }
  .receipt-row.total          { font-size: var(--font-total); }
  .receipt-footer             { font-size: var(--font-footer); }

  /* æ•°å­—ã¯ç­‰å¹… */
  .receipt-row span:last-child,
  .receipt-item-line span:last-child,
  .reference-number-value,
  .co-value {
    font-family: "Courier New", monospace !important;
    font-variant-numeric: tabular-nums !important;
  }

  /* èƒŒæ™¯ã‚„ã‚«ãƒ©ãƒ¼ãƒãƒƒã‚¸ã¯æ¶ˆã™ */
  .status-pill,
  .badge,
  .pill,
  .btn,
  .co-modal,
  .login-box,
  .table-wrap,
  .reference-number-display {
    background: transparent !important;
    border: none !important;
  }

  .receipt-items,
  .receipt-row.total,
  .receipt-separator {
    border-color: #000000 !important;
  }

  .receipt-box > * {
    page-break-inside: avoid !important;
  }
  
  .receipt-item-line span:last-child {
    white-space: nowrap !important;
  }

  /* åå‰ãŒé•·ã™ãã‚‹ã¨ãã¯å³ã‚’æŠ¼ã—ã¤ã¶ã•ãšã€Œâ€¦ã€ã§åˆ‡ã‚‹ */
  .receipt-item-line-name {
    max-width: 60% !important;         /* å¹…ã‚’åˆ¶é™ */
    white-space: nowrap !important;    /* 1 è¡Œã«åã‚ã‚‹ */
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }

}

/* ============================
   Android / ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘ï¼šæ–‡å­—ã ã‘æ‹¡å¤§ï¼ˆA-â‘¡ï¼‰
   ç”»é¢å¹… 1024px ä»¥ä¸‹ãªã‚‰ãƒ•ã‚©ãƒ³ãƒˆå¤‰æ•°ã‚’å¤§ããã™ã‚‹
   ============================ */
@media print and (max-width: 1024px) {
  :root {
    /* ã“ã“ã¯å¥½ã¿ã§èª¿æ•´ã—ã¦OKï¼ˆã¾ãšã¯ã‹ãªã‚Šå¤§ãã‚ã«ï¼‰ */
    --font-main:       16px;
    --font-shop-name:  24px;
    --font-title:      22px;
    --font-item:       16px;
    --font-total:      22px;
    --font-footer:     14px;
  }
}

/* ç”»é¢è¡¨ç¤ºç”¨ï¼ˆãŠå¥½ã¿ã§ï¼‰ */
@media screen and (max-width: 768px) {
  #receiptArea {
    padding: 4mm !important;
  }
  .receipt-box {
    padding: 6mm 4mm !important;
    max-width: 90% !important;
  }
}

/* æ”¯æ‰•ã„ãƒ‘ãƒãƒ«ã‚’ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
#checkout-modal {
  max-height: 100vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 12px;
}

/* ================================
   iPad POSé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³å¼·åŒ–ï¼ˆè¿½åŠ CSSï¼‰
   ================================ */

/* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã‚’ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰é¢¨ã« */
.co-modal {
  border-radius: 22px !important;
  padding: 28px 32px !important;
  background: #ffffff !important;
  color: #111 !important;
  box-shadow: 0 18px 60px rgba(0,0,0,0.4) !important;
  max-height: 90vh;
  overflow-y: auto;
}

/* ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ† â€“ iPadã®å¤ªã„ã‚¿ã‚¤ãƒˆãƒ« */
.co-header h2 {
  font-size: 26px !important;
  font-weight: 700 !important;
  color: #0f172a !important;
}

.co-sub {
  font-size: 14px !important;
  color: #64748b !important;
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ iPad POS é¢¨ã« */
.co-field input, 
.co-field select {
  background: #f8fafc !important;
  border-radius: 12px !important;
  border: 1px solid #cbd5e1 !important;
  padding: 12px 14px !important;
  font-size: 16px !important;
  height: 48px;
}

/* ãƒ©ãƒ™ãƒ« */
.co-field label {
  font-size: 13px !important;
  font-weight: 600 !important;
  color: #334155 !important;
}

/* è¡Œï¼ˆè¨ˆç®—ã‚¨ãƒªã‚¢ï¼‰ */
.co-row {
  font-size: 17px !important;
  padding: 6px 0 !important;
}

.co-value.strong {
  font-size: 20px !important;
  color: #0f172a !important;
  font-weight: 700 !important;
}

/* æ”¯æ‰•ã„æ–¹æ³•ã‚¨ãƒªã‚¢ã®èƒŒæ™¯ã‚«ãƒ¼ãƒ‰ */
.co-body {
  background: #f1f5f9 !important;
  border-radius: 16px;
  padding: 18px !important;
  border: none !important;
}

/* æœ€çµ‚åˆè¨ˆã®è¡Œ */
.co-row-total {
  font-size: 22px !important;
  font-weight: 700 !important;
  padding-top: 12px !important;
  border-top: 2px solid #cbd5e1 !important;
}

/* ãƒœã‚¿ãƒ³ã‚’ iPad é¢¨ã« */
.co-btn {
  height: 48px !important;
  font-size: 17px !important;
  padding: 0 24px !important;
  border-radius: 12px !important;
  font-weight: 600 !important;
}

.co-btn.primary {
  background: #2563eb !important;
  color: white !important;
  box-shadow: 0 4px 12px rgba(37,99,235,0.4);
}

.co-btn.primary:hover {
  background: #1d4ed8 !important;
}

.co-btn.ghost {
  background: #e2e8f0 !important;
  color: #0f172a !important;
}

.co-btn.ghost:hover {
  background: #cbd5e1 !important;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆä¸¸ãå¤§ããï¼‰ */
.co-close-btn {
  background: #e2e8f0 !important;
  color: #334155 !important;
  width: 36px !important;
  height: 36px !important;
  border-radius: 50% !important;
  font-size: 22px !important;
}

/* ===== iPad ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« èª¿æ•´ç‰ˆï¼ˆä¸Šæ›¸ãï¼‰ ===== */

/* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ï¼šå°‘ã—æ˜ã‚‹ã‚ã®ã‚«ãƒ¼ãƒ‰ */
.co-modal {
  background: #f9fafb !important;
  color: #0f172a !important;
}

/* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šç™½èƒŒæ™¯ï¼‹ãƒãƒƒã‚­ãƒªæ–‡å­—è‰² */
.co-field input,
.co-field select {
  background: #ffffff !important;
  border-radius: 12px !important;
  border: 1px solid #cbd5e1 !important;
  padding: 10px 14px !important;
  font-size: 16px !important;
  height: 44px;
  color: #0f172a !important;   /* â† æ–‡å­—ã‚’æ¿ƒã */
}

/* placeholder ã ã‘å°‘ã—è–„ã */
.co-field input::placeholder {
  color: #9ca3af !important;
}

/* ãƒ©ãƒ™ãƒ«ã¯æ¿ƒã„ã‚ã‚°ãƒ¬ãƒ¼ */
.co-field label {
  font-size: 13px !important;
  font-weight: 600 !important;
  color: #334155 !important;
}

/* ã‚»ãƒ¬ã‚¯ãƒˆã® option ã‚‚ãƒãƒƒã‚­ãƒªè‰²ã« */
.co-field select option {
  background: #ffffff;
  color: #0f172a;
}

/* disabled ã®ã¨ãã ã‘ â€œè–„ãâ€ */
.co-field input:disabled,
.co-field select:disabled {
  background: #e5e7eb !important;
  color: #9ca3af !important;
}

/* ä¸Šã®ã€ŒOriginal totalã€è¡Œã‚’ã‚«ãƒ¼ãƒ‰é¢¨ã« */
.co-row {
  font-size: 15px !important;
  padding: 6px 0 !important;
}

.co-row:first-child {
  background: #e5efff;
  border-radius: 16px;
  padding: 10px 16px !important;
  margin-bottom: 12px;
}

/* æœ€çµ‚åˆè¨ˆè¡Œã¯ã—ã£ã‹ã‚Šå¤ªã */
.co-row-total {
  font-size: 20px !important;
  font-weight: 700 !important;
  padding-top: 12px !important;
  border-top: 2px solid #cbd5e1 !important;
}

/* é‡‘é¡ã®æ–‡å­—ã‚’æ¿ƒãï¼†å¤§ãã */
.co-value.strong {
  font-size: 22px !important;
  color: #0f172a !important;
}

/* ãƒœã‚¿ãƒ³ï¼šã‚ˆã‚Š iPad ã£ã½ã */
.co-btn {
  height: 46px !important;
  font-size: 16px !important;
  border-radius: 999px !important;
  font-weight: 600 !important;
}

.co-btn.primary {
  background: linear-gradient(135deg,#2563eb,#1d4ed8) !important;
  color: #ffffff !important;
  box-shadow: 0 4px 12px rgba(37,99,235,0.35);
}

.co-btn.ghost {
  background: #e2e8f0 !important;
  color: #0f172a !important;
}

</style>
</head>
<body>
  <header>
    
    <div class="header-main">
      <div class="header-title">
        <h1>Advanced POS Counter Display</h1>
        <div class="sub">
          Showing orders for <span id="subtitleDate"></span> â€”
          <span id="subtitleFilter">Unpaid only</span>
        </div>
      </div>

      <div class="header-controls">
        <div class="bar-top">
          <div class="badge orders">Orders:<strong id="statOrders">0</strong></div>
          <div class="badge items">Items:<strong id="statItems">0</strong></div>
          <div class="badge amount">Amount:<strong id="statAmount">Â¥0</strong></div>
          <div class="badge paid">Paid:<strong id="statPaid">Â¥0</strong></div>
          <div class="badge pending">Pending:<strong id="statPending">Â¥0</strong></div>
          <div class="badge new">New:<strong id="statNew">0</strong></div>
        </div>

        <div class="bar-top">
          <label class="pill" id="pillUnpaidOnly">
            <input type="checkbox" id="chkUnpaid" checked /> Unpaid only
          </label>

          <label class="pill" id="pillCheckoutMode">
            <input type="checkbox" id="chkCheckoutMode" /> Checkout Mode
          </label>

          <div class="date-nav">
            <button id="btnPrevDate">&lt;</button>
            <input type="date" id="datePicker" />
            <button id="btnNextDate">&gt;</button>
          </div>

          <!-- Range for report -->
          <div class="range-nav">
            <input type="date" id="rangeStart" />
            <span>ã€œ</span>
            <input type="date" id="rangeEnd" />
          </div>

          <div class="btn-group">
            <button class="btn small primary" id="btnCheckout" disabled>Checkout Selected</button>
            <button class="btn small" id="btnDailyReport">Daily Report</button>
            <button class="btn small" id="btnRangeReport">Range Report</button>
            <button class="btn small" id="btnReprint">ğŸ–¨ï¸ å†ç™ºè¡Œ</button>
            <button class="btn small" id="btnBluetooth">ğŸ“¡ Connect Bluetooth</button>
            <button class="btn small" id="btnAutoPrint">ğŸ”— Auto-Print OFF</button>
            <button class="btn small primary" id="btnSound">ğŸ”” Sound</button>
            <button class="btn small" id="btnPrint">ğŸ–¨ï¸ Print</button>
            <button class="btn small" id="btnTestPrint">Test Print</button>
            <button class="btn small danger" id="btnLogout" style="display:none;">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Time</th><th>Table</th><th>Food</th>
            <th>Set</th><th>Rice|Naan</th><th>Spice</th>
            <th>Drink</th><th>Note</th>
            <th style="text-align:right;">Price (Â¥)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </main>

  <!-- LOGIN -->
  <div id="loginOverlay">
    <div class="login-box">
      <h2>Staff Login</h2>
      <label>Staff ID</label>
      <input id="staffId" placeholder="e.g. A001" />
      <label>PIN</label>
      <input id="staffPin" type="password" placeholder="4 digits" />
      <button id="btnLogin">Login</button>
      <div class="login-error" id="loginError"></div>
      <div class="login-info">
        Staff ID / PIN are configured in <code>code.gs</code> under <code>STAFF_LIST</code>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkout-backdrop" class="co-backdrop hidden"></div>
  <div id="checkout-modal" class="co-modal hidden">
    <div class="co-header">
      <div>
        <h2>Checkout</h2>
        <p id="co-orders-count" class="co-sub">Orders selected: 0</p>
      </div>
      <button class="co-close-btn" onclick="closeCheckoutModal()">Ã—</button>
    </div>

    <div class="co-body">
      <div class="co-row">
        <label>Original total</label>
        <div class="co-value">Â¥<span id="co-original">0</span></div>
      </div>

      <div class="co-grid">
        <div class="co-field">
          <label for="co-discount-type">Discount type</label>
          <select id="co-discount-type" onchange="updateFinalTotal()">
            <option value="none">No discount</option>
            <option value="percent">% Percent</option>
            <option value="fixed">Â¥ Fixed</option>
          </select>
        </div>
        <div class="co-field">
          <label for="co-discount-value">Discount value</label>
          <input id="co-discount-value" type="number" min="0" step="1"
                 value="0" oninput="updateFinalTotal()" />
        </div>
      </div>

      <div class="co-grid">
        <div class="co-field">
          <label for="co-method">Payment method</label>
          <select id="co-method" onchange="updateChangeVisibility()">
            <option value="cash">Cash / ç¾é‡‘</option>
            <option value="card">Credit Card / ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</option>
            <option value="qr">QR Code / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹</option>
            <option value="mixed">Mixed (Cash + Other)</option>
          </select>
        </div>
        <div class="co-field">
          <label for="co-ref">Payment Ref</label>
          <input id="co-ref" type="text"
                 placeholder="Card last 4 / QR ID (optional)" />
        </div>
      </div>

      <!-- Reference Number Input (UI-only preview) -->
      <div class="co-grid">
        <div class="co-field">
          <label for="co-reference">Reference Number (å‚ç…§ç•ªå·)</label>
          <input id="co-reference" type="text"
                 placeholder="Auto-generated preview"
                 onchange="updateReferenceNumber()" />
        </div>
        <div class="co-field">
          <label style="color: #6b7280; font-size: 10px;">
            Actualç•ªå·ã¯ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•æ¡ç•ªã—ã¾ã™<br>
            This field is for preview only
          </label>
        </div>
      </div>

      <div id="co-cash-block">
        <div class="co-grid">
          <div class="co-field">
            <label for="co-received">Amount received (ç¾é‡‘å—å–é¡)</label>
            <input id="co-received" type="number" min="0" step="1"
                   value="" oninput="updateChange()" placeholder="Enter amount received" />
          </div>
          <div class="co-field">
            <label>Change to return (ãŠé‡£ã‚Š)</label>
            <div class="co-value strong">Â¥<span id="co-change">0</span></div>
          </div>
        </div>
      </div>

      <!-- Receipt Type Selection -->
      <div class="co-grid">
        <div class="co-field">
          <label for="co-receipt-type">Receipt Type</label>
          <select id="co-receipt-type">
            <option value="normal">Normal Receipt (ãƒ¬ã‚·ãƒ¼ãƒˆ)</option>
            <option value="formal">Formal Receipt (é ˜åæ›¸)</option>
          </select>
        </div>
        <div class="co-field">
          <label for="co-receipt-name">Receipt Name (å®›å)</label>
          <input id="co-receipt-name" type="text" placeholder="Optional - for formal receipt" style="display:none;" />
        </div>
      </div>

      <div class="co-row co-row-total">
        <label>Final total</label>
        <div class="co-value strong">Â¥<span id="co-final">0</span></div>
      </div>
    </div>

    <div class="co-footer">
      <button class="co-btn ghost" onclick="closeCheckoutModal()">Cancel</button>
      <button class="co-btn primary" onclick="applyCheckout()">Apply &amp; Paid</button>
    </div>
  </div>

  <!-- REPRINT MODAL -->
  <div id="reprint-backdrop" class="co-backdrop hidden"></div>
  <div id="reprint-modal" class="co-modal hidden" style="width: 500px;">
    <div class="co-header">
      <div>
        <h2>é ˜åæ›¸ãƒ»ãƒ¬ã‚·ãƒ¼ãƒˆå†ç™ºè¡Œ</h2>
        <p class="co-sub">Receipt Reprint System</p>
      </div>
      <button class="co-close-btn" onclick="closeReprintModal()">Ã—</button>
    </div>

    <div class="co-body">
      <div class="co-grid">
        <div class="co-field">
          <label for="reprint-search-type">Search Type</label>
          <select id="reprint-search-type">
            <option value="date">By Date Range</option>
            <option value="search">Search Orders</option>
          </select>
        </div>
        <div class="co-field">
          <label for="reprint-receipt-type">Receipt Type</label>
          <select id="reprint-receipt-type">
            <option value="normal">Normal Receipt (ãƒ¬ã‚·ãƒ¼ãƒˆ)</option>
            <option value="formal">Formal Receipt (é ˜åæ›¸)</option>
          </select>
        </div>
      </div>

      <!-- Date Range Search -->
      <div id="reprint-date-search">
        <div class="co-grid">
          <div class="co-field">
            <label for="reprint-start-date">From Date</label>
            <input type="date" id="reprint-start-date" />
          </div>
          <div class="co-field">
            <label for="reprint-end-date">To Date</label>
            <input type="date" id="reprint-end-date" />
          </div>
        </div>
      </div>

      <!-- Text Search -->
      <div id="reprint-text-search" style="display: none;">
        <div class="co-grid">
          <div class="co-field">
            <label for="reprint-search-term">Search (Reference No./Table No.)</label>
            <input type="text" id="reprint-search-term" placeholder="Enter reference number (e.g., 251129-0001) or table number" />
          </div>
          <div class="co-field">
            <label for="reprint-search-date">Date (Optional)</label>
            <input type="date" id="reprint-search-date" />
          </div>
        </div>
      </div>

      <div class="co-field full-width">
        <label for="reprint-receipt-name">Receipt Name (å®›å) - for formal receipts</label>
        <input type="text" id="reprint-receipt-name" placeholder="Optional - for formal receipt" />
      </div>

      <div class="co-field full-width">
        <label class="pill">
          <input type="checkbox" id="reprint-unpaid-only" checked /> Unpaid only
        </label>
      </div>

      <div class="co-footer" style="justify-content: center; margin-top: 16px;">
        <button class="co-btn primary" onclick="searchReprintOrders()">
          <span class="loading" id="reprint-loading" style="display: none;"></span>
          Search Orders
        </button>
      </div>

      <!-- Search Results -->
      <div id="reprint-results" style="display: none; margin-top: 16px;">
        <div style="border-top: 1px solid #1f2937; padding-top: 12px;">
          <h4 style="margin: 0 0 12px 0; font-size: 14px;">Found Orders: <span id="reprint-results-count">0</span></h4>

          <div class="warning-message">
            æœªæ‰•ã„æ³¨æ–‡ã¯æ”¯æ‰•ã„å±¥æ­´ãŒãªã„ãŸã‚å†ç™ºè¡Œã§ãã¾ã›ã‚“
          </div>

          <div id="reprint-orders-list" style="border: 1px solid #1f2937; border-radius: 8px; padding: 8px;">
            <!-- Orders will be listed here -->
          </div>
        </div>
      </div>
    </div>

    <div class="co-footer">
      <button class="co-btn ghost" onclick="closeReprintModal()">Cancel</button>
      <button class="co-btn primary" id="btn-print-selected" style="display: none;" onclick="printSelectedReprint()">Print Selected</button>
    </div>
  </div>

  <!-- RECEIPT / INVOICE PRINT AREA -->
  <div id="receiptArea"></div>

  <script>
    const CONFIG = {
      autoRefreshInterval: 2000,
      inactivityTimeout: 30 * 60 * 1000,
      maxTableLength: 20,
      maxFoodLength: 50,
      receipt: {
        shopName: "ã‚¢ã‚¸ã‚¢ãƒ³ãƒ€ã‚¤ãƒ‹ã‚°å¤¢éŒ¦ç³¸ç”º",
        shopAddr: "ã€’130-0022 æ±äº¬éƒ½å¢¨ç”°åŒºæ±Ÿæ±æ©‹4ä¸ç›®20âˆ’7 ç¬¬ä¸€å›½æ¾ãƒ“ãƒ«ï¼‘F",
        shopTel: "TEL: 03-6388-1168"
      }
    };

    let allOrders = [];
    let filtered = [];
    let selectedKeys = new Set();
    let currentStaff = null;
    let lastUnpaidCount = 0;
    let soundEnabled = true;
    let autoRefreshTimer = null;
    let inactivityTimer = null;
    let isLoading = false;

    let checkoutState = { orderIds: [], originalTotal: 0, orders: [] };
    let reprintState = {
      selectedOrders: new Set(),
      currentOrders: []
    };

    /******************************************************
     * BLUETOOTH PRINTER VARIABLES
     ******************************************************/
    let bluetoothDevice = null;
    let bluetoothCharacteristic = null;
    let isBluetoothConnected = false;

    function fmtTime(value){
      if (!value) return "";
      const d = value instanceof Date ? value : new Date(value);
      if (isNaN(d.getTime())) return String(value);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return hh + ":" + mm + ":" + ss;
    }
    function fmtDateISO(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return yy + "-" + mm + "-" + dd;
    }
    function sameDay(a,b){
      return a.getFullYear()===b.getFullYear() &&
             a.getMonth()===b.getMonth() &&
             a.getDate()===b.getDate();
    }
    function parseDateSafe(dateStr){
      if (!dateStr) return new Date();
      const date = new Date(dateStr);
      return isNaN(date.getTime()) ? new Date() : date;
    }
    function playDing(){
      if (!soundEnabled) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type="sine";osc.frequency.value=880;
        osc.connect(gain);gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.001,ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.3,ctx.currentTime+0.02);
        gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.25);
        osc.start();osc.stop(ctx.currentTime+0.3);
      }catch(e){}
    }
    function formatCurrency(amount){return "Â¥"+Number(amount||0).toLocaleString();}

    function showToast(message,type){
      if(!type) type="info";
      const toast=document.createElement("div");
      toast.className="toast "+type;
      toast.textContent=message;
      document.body.appendChild(toast);
      setTimeout(function(){toast.classList.add("show");},10);
      setTimeout(function(){
        toast.classList.remove("show");
        setTimeout(function(){
          if(toast.parentNode) toast.parentNode.removeChild(toast);
        },300);
      },5000);
    }

    function setLoading(state){
      isLoading = state;
    }

    function resetInactivityTimer(){
      clearTimeout(inactivityTimer);
      if(currentStaff){
        inactivityTimer=setTimeout(function(){
          showToast("Session expired due to inactivity","warning");
          logout();
        },CONFIG.inactivityTimeout);
      }
    }

    function logout(){
      currentStaff=null;
      clearInterval(autoRefreshTimer);autoRefreshTimer=null;
      clearTimeout(inactivityTimer);inactivityTimer=null;
      document.getElementById("loginOverlay").style.display="flex";
      document.getElementById("btnLogout").style.display="none";
      selectedKeys.clear();allOrders=[];render();
      showToast("Logged out successfully","info");
    }

    function sanitizeOrder(order){
      let riceRaw="";
      if(order && order.riceNaan!=null && order.riceNaan!==""){riceRaw=order.riceNaan;}
      else if(order && order.rice_naan!=null && order.rice_naan!==""){riceRaw=order.rice_naan;}
      else if(order && order["Rice|Naan"]!=null && order["Rice|Naan"]!==""){riceRaw=order["Rice|Naan"];}
      else if(order && order.rice!=null && order.rice!==""){riceRaw=order.rice;}

      return {
        key:String(order.key||""),
        ts:order.ts||new Date(),
        table:String(order.table||"").substring(0,CONFIG.maxTableLength),
        food:String(order.food||"").substring(0,CONFIG.maxFoodLength),
        set:String(order.set||"").substring(0,30),
        riceNaan:String(riceRaw||"").substring(0,20),
        spice:String(order.spice||"").substring(0,20),
        drink:String(order.drink||"").substring(0,20),
        note:String(order.note||"").substring(0,100),
        price:Math.max(0,Number(order.price)||0),
        status:String(order.status||"unpaid").toLowerCase()
      };
    }

    function render(){
      const body=document.getElementById("ordersBody");
      body.innerHTML="";

      const unpaidOnly=document.getElementById("chkUnpaid").checked;
      const todayStr=document.getElementById("datePicker").value;
      const targetDate=parseDateSafe(todayStr);

      document.getElementById("subtitleDate").textContent=todayStr||fmtDateISO(targetDate);
      document.getElementById("subtitleFilter").textContent=
        unpaidOnly?"Unpaid only":"All statuses";

      filtered=allOrders.filter(function(o){
        if(!o.ts) return false;
        const d=new Date(o.ts);
        if(!sameDay(d,targetDate)) return false;
        if(unpaidOnly && String(o.status).toLowerCase()!=="unpaid") return false;
        return true;
      });

      let ordersCount=filtered.length;
      let itemsCount=0,totalAmount=0,paidAmount=0,pendingAmount=0;

      filtered.forEach(function(rawOrder){
        const o=sanitizeOrder(rawOrder);

        let qty=1;
        const m=String(o.food||"").match(/^(\d+)\s*x/i);
        if(m) qty=Number(m[1]);
        if(!isNaN(qty)) itemsCount+=qty;

        const price=Number(o.price||0);
        totalAmount+=price;
        if(o.status==="paid") paidAmount+=price; else pendingAmount+=price;

        const tr=document.createElement("tr");
        if(selectedKeys.has(o.key)) tr.classList.add("row-selected");

        const tdSel=document.createElement("td");
        const isPaid = o.status === "paid";
        const isCheckoutMode = document.getElementById("chkCheckoutMode").checked;

        if(isCheckoutMode){
          const cb=document.createElement("input");
          cb.type="checkbox";
          cb.checked=selectedKeys.has(o.key);
          cb.disabled = isPaid;
          cb.addEventListener("change",function(){
            if(!isPaid) {
              if(cb.checked) selectedKeys.add(o.key);
               else selectedKeys.delete(o.key);
              tr.classList.toggle("row-selected",cb.checked);
              updateCheckoutButtonState();
            }
          });
          tdSel.appendChild(cb);

          if(isPaid) {
            tr.classList.add("paid-order-disabled");
          }
        } else {
          tdSel.textContent="";
        }
        tr.appendChild(tdSel);

        const tdTime=document.createElement("td");
        tdTime.textContent=fmtTime(o.ts);tdTime.className="time";tr.appendChild(tdTime);

        const tdTable=document.createElement("td");
        tdTable.textContent=o.table||"";tr.appendChild(tdTable);

        const tdFood=document.createElement("td");
        tdFood.textContent=o.food||"";tr.appendChild(tdFood);

        const tdSet=document.createElement("td");
        tdSet.textContent=o.set||"";tr.appendChild(tdSet);

        const tdRice=document.createElement("td");
        tdRice.textContent=o.riceNaan||"";tr.appendChild(tdRice);

        const tdSpice=document.createElement("td");
        tdSpice.textContent=o.spice||"";tr.appendChild(tdSpice);

        const tdDrink=document.createElement("td");
        tdDrink.textContent=o.drink||"";tr.appendChild(tdDrink);

        const tdNote=document.createElement("td");
        tdNote.textContent=o.note||"";tr.appendChild(tdNote);

        const tdPrice=document.createElement("td");
        tdPrice.textContent="Â¥"+Number(o.price||0).toLocaleString();
        tdPrice.className="price";tr.appendChild(tdPrice);

        const tdStatus=document.createElement("td");
        const pill=document.createElement("span");
        pill.className="status-pill "+(o.status==="paid"?"status-paid":"status-unpaid");
        pill.textContent=o.status||"Unpaid";
        tdStatus.appendChild(pill);
        tr.appendChild(tdStatus);

        tr.addEventListener("click",function(ev){
          if(!isCheckoutMode) return;
          if(ev.target.tagName==="INPUT") return;
          if(isPaid) {
            showToast("Paid orders cannot be selected", "warning");
            return;
          }

          const checked=!selectedKeys.has(o.key);
          if(checked) selectedKeys.add(o.key);
           else selectedKeys.delete(o.key);
          tr.classList.toggle("row-selected",checked);
          const c=tdSel.querySelector("input");
          if(c) c.checked=checked;
          updateCheckoutButtonState();
        });

        body.appendChild(tr);
      });

      document.getElementById("statOrders").textContent=ordersCount;
      document.getElementById("statItems").textContent=itemsCount;
      document.getElementById("statAmount").textContent="Â¥"+totalAmount.toLocaleString();
      document.getElementById("statPaid").textContent="Â¥"+paidAmount.toLocaleString();
      document.getElementById("statPending").textContent="Â¥"+pendingAmount.toLocaleString();

      const unpaidCount=filtered.filter(function(o){
        return String(o.status).toLowerCase()==="unpaid";
      }).length;
      document.getElementById("statNew").textContent=Math.max(unpaidCount-lastUnpaidCount,0);
      if(unpaidCount>lastUnpaidCount) playDing();
      lastUnpaidCount=unpaidCount;

      updateCheckoutButtonState();
    }

    function updateCheckoutButtonState(){
      const btn=document.getElementById("btnCheckout");
      const inMode=document.getElementById("chkCheckoutMode").checked;
      btn.disabled=!(inMode && selectedKeys.size>0);
    }

    function loadData(){
      if(isLoading) return;
      setLoading(true);

      if(!window.google || !google.script || !google.script.run){
        console.error("google.script.run not available");
        showToast("Connection error - please refresh page","error");
        setLoading(false);
        return;
      }

      google.script.run
        .withSuccessHandler(function(res){
          setLoading(false);
          if(!res || !res.success){
            showToast(res && res.message ? res.message : "Failed to load data","error");
            return;
          }
          allOrders=res.data || [];
          render();
        })
        .withFailureHandler(function(error){
          setLoading(false);
          showToast("Network error: "+error.message,"error");
          console.error("Load error:",error);
        })
        .getCounterData();
    }

    document.getElementById("btnLogin").addEventListener("click", function () {
      const id  = document.getElementById("staffId").value.trim();
      const pin = document.getElementById("staffPin").value.trim();
      const errEl = document.getElementById("loginError");
      errEl.textContent = "";

      if (!id || !pin) {
        errEl.textContent = "ID and PIN are required";
        return;
      }
      if (!window.google || !google.script || !google.script.run) {
        errEl.textContent = "Cannot connect to server. Please open the Web App /exec URL and check network.";
        return;
      }

      google.script.run
        .withSuccessHandler(function (res) {
          if (!res || !res.success) {
            errEl.textContent = (res && res.message) ? res.message : "Login failed";
            return;
          }

          currentStaff = res.staff;
          document.getElementById("loginOverlay").style.display = "none";
          document.getElementById("btnLogout").style.display = "inline-flex";

          const today = new Date();
          document.getElementById("datePicker").value = fmtDateISO(today);

          const first = new Date(today.getFullYear(), today.getMonth(), 1);
          document.getElementById("rangeStart").value = fmtDateISO(first);
          document.getElementById("rangeEnd").value   = fmtDateISO(today);

          loadData();
          showToast("Welcome, " + currentStaff.name + "!", "success");

          if (!autoRefreshTimer) {
            autoRefreshTimer = setInterval(loadData, CONFIG.autoRefreshInterval);
          }
          resetInactivityTimer();
        })
        .withFailureHandler(function (error) {
          errEl.textContent = "Login failed: " + error.message;
        })
        .verifyStaff(id, pin);
    });

    document.getElementById("chkUnpaid").addEventListener("change",function(){
      document.getElementById("pillUnpaidOnly").classList.toggle("active",this.checked);
      render();
    });

    document.getElementById("chkCheckoutMode").addEventListener("change",function(){
      document.getElementById("pillCheckoutMode").classList.toggle("active",this.checked);
      selectedKeys.clear();
      render();
    });

    document.getElementById("btnPrevDate").addEventListener("click",function(){
      const val=document.getElementById("datePicker").value;
      const d=parseDateSafe(val);d.setDate(d.getDate()-1);
      document.getElementById("datePicker").value=fmtDateISO(d);render();
    });

    document.getElementById("btnNextDate").addEventListener("click",function(){
      const val=document.getElementById("datePicker").value;
      const d=parseDateSafe(val);const today=new Date();
      if(d>=today){showToast("Cannot view future dates","warning");return;}
      d.setDate(d.getDate()+1);
      document.getElementById("datePicker").value=fmtDateISO(d);render();
    });

    document.getElementById("datePicker").addEventListener("change",function(){
      const val=this.value;
      const selectedDate=new Date(val);
      const today=new Date();
      if(selectedDate>today){
        showToast("Cannot view future dates","warning");
        this.value=fmtDateISO(today);
      }
      render();
    });

    document.getElementById("btnSound").addEventListener("click",function(){
      soundEnabled=!soundEnabled;
      this.classList.toggle("primary",soundEnabled);
      this.textContent=soundEnabled?"ğŸ”” Sound On":"ğŸ”• Sound Off";
      showToast(soundEnabled?"Sound enabled":"Sound disabled","info");
    });

    // FIXED PRINT FUNCTION
    document.getElementById("btnPrint").addEventListener("click", function () {
      if (!window.currentReceiptInfo) {
        showToast("No receipt to print. Please complete a payment or use Reprint.", "warning");
        return;
      }

      // Build receipt with current info
      const mode = window.currentReceiptInfo.receiptType === "formal" ? "formal" : "normal";
      
      // Clear and rebuild receipt area
      const area = document.getElementById("receiptArea");
      area.innerHTML = `
        <button class="receipt-close-btn" onclick="closeReceipt()">Ã— Close</button>
        <button class="receipt-print-btn" onclick="printReceiptBrowser()">ğŸ–¨ Print</button>
        ${isBluetoothConnected ? '<button class="receipt-bluetooth-btn" onclick="printCurrentReceiptToBluetooth()">ğŸ–¨ï¸ Bluetooth Print</button>' : ''}
        <div id="receiptContainer"></div>
      `;
      area.style.display = "block";

      // Build receipt content
      buildReceiptHtml(mode, window.currentReceiptInfo);

      // Android compatibility: force reflow
      void area.offsetHeight;

      // Print with delay for rendering
      setTimeout(printReceiptBrowser, 100);
    });

    // FIXED PRINT FUNCTION FOR BROWSER
    function printReceiptBrowser() {
      // Close any modals first
      closeCheckoutModal();
      closeReprintModal();
      
      // For Android, we need to ensure the receipt is properly shown
      const area = document.getElementById("receiptArea");
      if (area) {
        // Force display
        area.style.display = "block";
        
        // Different approach for Android vs PC
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          // For mobile devices
          setTimeout(() => {
            window.print();
            // Don't close immediately, let print dialog handle it
          }, 200);
        } else {
          // For desktop
          window.print();
        }
      }
    }

    // Update logout button
    document.getElementById("btnLogout").addEventListener("click", logout);

    // Test print function
    document.getElementById("btnTestPrint").addEventListener("click",function(){
      runTestPrint();
    });

    // Daily report
    document.getElementById("btnDailyReport").addEventListener("click",function(){
      const dateStr=document.getElementById("datePicker").value;
      if(!dateStr){
        showToast("Please select a date first","warning");
        return;
      }

      if(!window.google || !google.script || !google.script.run){
        showToast("Cannot connect to server","error");return;
      }

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(res){
          setLoading(false);
          if(!res || !res.success){
            showToast(res && res.message ? res.message : "Daily report error","error");
            return;
          }
          const msg =
            "Daily Report\n" +
            "Date: "+res.date+"\n"+
            "Orders: "+res.orders+"\n"+
            "Items: "+res.items+"\n"+
            "Gross: "+formatCurrency(res.gross)+"\n"+
            "Discount: "+formatCurrency(res.discount)+"\n"+
            "Net: "+formatCurrency(res.net);
          alert(msg);
        })
        .withFailureHandler(function(err){
          setLoading(false);
          showToast("Daily report error: "+err.message,"error");
        })
        .getDailyReport(dateStr);
    });

    // Range report
    document.getElementById("btnRangeReport").addEventListener("click",function(){
      const startStr=document.getElementById("rangeStart").value;
      const endStr=document.getElementById("rangeEnd").value;

      if(!startStr || !endStr){
        showToast("Please choose start & end date","warning");return;
      }
      const s=new Date(startStr);
      const e=new Date(endStr);
      if(s>e){
        showToast("Start date is after end date","warning");return;
      }

      const today = new Date();
      if(s > today || e > today){
        showToast("Cannot select future dates for reports","warning");
        return;
      }

      if(!window.google || !google.script || !google.script.run){
        showToast("Cannot connect to server","error");return;
      }

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(res){
          setLoading(false);
          if(!res || !res.success){
            showToast(res && res.message ? res.message : "Range report error","error");
            return;
          }
          const msg =
            "Range Report\n" +
            "Period: "+res.start+" ã€œ "+res.end+"\n"+
            "Orders: "+res.orders+"\n"+
            "Items: "+res.items+"\n"+
            "Gross: "+formatCurrency(res.gross)+"\n"+
            "Discount: "+formatCurrency(res.discount)+"\n"+
            "Net: "+formatCurrency(res.net);
          alert(msg);
        })
        .withFailureHandler(function(err){
          setLoading(false);
          showToast("Range report error: "+err.message,"error");
        })
        .getRangeReport(startStr,endStr);
    });

    // Checkout button
    document.getElementById("btnCheckout").addEventListener("click",function(){
      if(selectedKeys.size===0) return;
      const summary=getSelectedOrdersSummary();
      if(!summary.orders.length){
        showToast("No valid orders selected","warning");return;
      }
      openCheckoutModal(summary);
    });

    function getSelectedOrdersSummary(){
      const selected=[];let originalTotal=0;
      allOrders.forEach(function(raw){
        const o=sanitizeOrder(raw);
        if(selectedKeys.has(o.key) && o.status !== "paid") {
          selected.push(o);
          originalTotal+=Number(o.price || 0);
        }
      });
      return {orders:selected,originalTotal:originalTotal};
    }

    function openCheckoutModal(summary){
      checkoutState.orderIds = summary.orders.map(function(o){return o.key;});
      checkoutState.originalTotal = summary.originalTotal || 0;
      checkoutState.orders = summary.orders || [];

      document.getElementById("co-orders-count").textContent =
        "Orders selected: "+checkoutState.orderIds.length;
      document.getElementById("co-original").textContent =
        checkoutState.originalTotal.toLocaleString();

      document.getElementById("co-discount-type").value="none";
      document.getElementById("co-discount-value").value=0;
      document.getElementById("co-method").value="cash";
      document.getElementById("co-ref").value="";

      document.getElementById("co-reference").value = generateReferencePreview();

      document.getElementById("co-received").value="";
      document.getElementById("co-change").textContent="0";

      document.getElementById("co-receipt-type").value="normal";
      document.getElementById("co-receipt-name").value="";
      document.getElementById("co-receipt-name").style.display="none";

      updateFinalTotal();
      updateChangeVisibility();

      document.getElementById("checkout-backdrop").classList.remove("hidden");
      document.getElementById("checkout-modal").classList.remove("hidden");
    }

    function generateReferencePreview() {
      const now = new Date();
      const datePart = now.getFullYear().toString().slice(-2) +
                      String(now.getMonth() + 1).padStart(2, '0') +
                      String(now.getDate()).padStart(2, '0');
      return datePart + '-XXXX';
    }

    function updateReferenceNumber() {
      const refInput = document.getElementById("co-reference");
      const value = refInput.value.trim();

      if (value && !/^\d{6}-\d{4}$/.test(value)) {
        showToast("Reference format should be YYMMDD-XXXX (e.g., 251129-0001)", "warning");
      }
    }

    function closeCheckoutModal(){
      document.getElementById("checkout-backdrop").classList.add("hidden");
      document.getElementById("checkout-modal").classList.add("hidden");
    }

    function updateFinalTotal(){
      const type=document.getElementById("co-discount-type").value;
      const val=Number(document.getElementById("co-discount-value").value)||0;

      let discountAmount=0;
      if(type==="percent"){
        discountAmount=Math.floor(checkoutState.originalTotal*(val/100));
      }else if(type==="fixed"){
        discountAmount=val;
      }
      if(discountAmount<0) discountAmount=0;
      if(discountAmount>checkoutState.originalTotal){
        discountAmount=checkoutState.originalTotal;
      }

      const finalTotal=checkoutState.originalTotal-discountAmount;
      document.getElementById("co-final").textContent=finalTotal.toLocaleString();
      updateChange();
    }

    function updateChangeVisibility(){
      const method=document.getElementById("co-method").value;
      const cashBlock=document.getElementById("co-cash-block");
      if(method==="cash" || method==="mixed"){
        cashBlock.style.display="block";
      }else{
        cashBlock.style.display="none";
        document.getElementById("co-change").textContent="0";
      }
      updateChange();
    }

    function updateChange(){
      const method=document.getElementById("co-method").value;
      const finalTotal=Number(
        document.getElementById("co-final").textContent.replace(/,/g,"")
      )||0;

      if(method!=="cash" && method!=="mixed"){
        document.getElementById("co-change").textContent="0";return;
      }
      const received=Number(document.getElementById("co-received").value)||0;
      let change=received-finalTotal;
      if(change<0) change=0;
      document.getElementById("co-change").textContent=change.toLocaleString();
    }

    function closeReceipt(){
      const area=document.getElementById("receiptArea");
      if(!area) return;
      area.style.display="none";
      area.innerHTML="";
    }

    /******************************************************
     * BLUETOOTH PRINTER FUNCTIONS
     ******************************************************/

    function isWebBluetoothAvailable() {
      return navigator.bluetooth ? true : false;
    }

    async function connectBluetoothPrinter() {
      try {
        if (!isWebBluetoothAvailable()) {
          showToast('Bluetooth is not supported in this browser', 'error');
          return false;
        }

        showToast('Searching for Bluetooth printer...', 'info');

        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] },
            { namePrefix: 'Blue' },
            { namePrefix: 'POS' },
            { namePrefix: 'Print' },
            { namePrefix: 'BT' }
          ],
          optionalServices: [
            '000018f0-0000-1000-8000-00805f9b34fb',
            '0000ae01-0000-1000-8000-00805f9b34fb',
            '0000ae00-0000-1000-8000-00805f9b34fb',
            '49535343-fe7d-4ae5-8fa9-9fafd205e455'
          ]
        });

        showToast(`Connecting to ${device.name}...`, 'info');

        const server = await device.gatt.connect();

        const services = [
          '000018f0-0000-1000-8000-00805f9b34fb',
          '0000ae01-0000-1000-8000-00805f9b34fb',
          '49535343-fe7d-4ae5-8fa9-9fafd205e455'
        ];

        let serviceFound = false;
        for (const serviceUUID of services) {
          try {
            const service = await server.getPrimaryService(serviceUUID);
            const characteristics = await service.getCharacteristics();

            for (const characteristic of characteristics) {
              if (characteristic.properties.write) {
                bluetoothDevice = device;
                bluetoothCharacteristic = characteristic;
                isBluetoothConnected = true;
                serviceFound = true;

                device.addEventListener('gattserverdisconnected', () => {
                  isBluetoothConnected = false;
                  bluetoothDevice = null;
                  bluetoothCharacteristic = null;
                  showToast('Bluetooth printer disconnected', 'warning');
                  updateBluetoothButtonState();
                });

                showToast(`Connected to ${device.name}`, 'success');
                updateBluetoothButtonState();
                return true;
              }
            }
          } catch (error) {
            console.log(`Service ${serviceUUID} not found`);
          }
        }

        if (!serviceFound) {
          throw new Error('No compatible printer service found');
        }

      } catch (error) {
        console.error('Bluetooth connection error:', error);
        if (error.name === 'NotFoundError') {
          showToast('No Bluetooth printer found', 'error');
        } else if (error.name === 'SecurityError') {
          showToast('Bluetooth permission denied', 'error');
        } else {
          showToast(`Connection failed: ${error.message}`, 'error');
        }
        updateBluetoothButtonState();
        return false;
      }
    }

    function escPosSafe(str) {
      if (!str) return "";
      // Remove non-ASCII for safety (no Japanese here, only receipt for BT printer)
      return String(str).replace(/[^\x20-\x7E]/g, '');
    }

    // Convert text to ESC/POS-safe ASCII (Android Bluetooth printers)
    function escPosEncodeJapanese(text) {
      if (!text) return new Uint8Array();

      // Convert text to Shift-JIS (for ESC/POS Japanese printers)
      const encoder = new TextEncoder("shift_jis", { NONSTANDARD_allowLegacyEncoding: true });
      return encoder.encode(text);
    }

    function generateEscPosReceipt(receiptData) {
      const ESC = 0x1B;
      const GS  = 0x1D;
      const encoder = new TextEncoder(); // UTF-8 â†’ ASCII éƒ¨åˆ†ã ã‘ä½¿ç”¨

      // 58mm ã®ä¸€èˆ¬çš„ãªè¡Œå¹…ï¼ˆåŠè§’ã§ 32 æ–‡å­—ãã‚‰ã„ï¼‰
      const LINE_CHARS = 32;

      function escPosSafe(str) {
        if (!str) return "";
        // ãƒ—ãƒªãƒ³ã‚¿ãŒè‹¦æ‰‹ãªåˆ¶å¾¡æ–‡å­—ã‚„å…¨ãã®ãƒã‚¤ãƒŠãƒªã¯æ¶ˆã™
        return String(str).replace(/[^\x20-\x7E]/g, '');
      }

      // å·¦åˆ—ï¼‹å³åˆ—ã§ 1 è¡Œã‚’ä½œã‚‹ï¼ˆâ‘¡ï¼šå•†å“å·¦ / é‡‘é¡å³ï¼‰
      function makeTwoCol(left, right) {
        left  = escPosSafe(left);
        right = escPosSafe(right);

        const leftMax = 22; // å·¦ã«ã ã„ãŸã„ 22 æ–‡å­—ã¶ã‚“
        let l = left.length > leftMax ? left.slice(0, leftMax) : left;

        const r = right;
        const space = LINE_CHARS - l.length - r.length;
        return l + ' '.repeat(Math.max(space, 1)) + r;
      }

      let bytes = [];

      function push(...arr) {
        bytes.push(...arr);
      }
      function pushText(str) {
        push(...encoder.encode(str));
      }

      // ---------- åˆæœŸåŒ– ----------
      push(ESC, 0x40);                 // ESC @ = åˆæœŸåŒ–
      push(ESC, 0x52, 0x08);           // å›½ : Japan (ä»®) ESC R 8
      push(ESC, 0x4d, 0x00);           // Font A
      push(ESC, 0x21, 0x00);           // æ¨™æº–ãƒ•ã‚©ãƒ³ãƒˆ
      push(ESC, 0x61, 0x01);           // ä¸­å¤®å¯„ã›

      // ---------- åº—åï¼ˆA: ä¸€ç•ªå¤§ãã + å¤ªå­—ï¼‰ ----------
      let shopName = receiptData.shopName || "ASIAN DINING YUME";
      let shopAddr = receiptData.shopAddr || "SUMIDA-KU TOKYO";
      let shopTel  = receiptData.shopTel  || "TEL: 03-0000-0000";

      shopName = escPosSafe(shopName);
      shopAddr = escPosSafe(shopAddr);
      shopTel  = escPosSafe(shopTel);

      // æ—¥æœ¬èªå¯¾å¿œï¼šå¤§ãã + å¤ªå­— + æ¨ª2å€
      push(GS, 0x21, 0x20);  // æ¨ªå¹…2å€
      push(ESC, 0x21, 0x30); // å¤ªå­— + é«˜ã•2å€
      
      pushText(shopName + "\n");
      pushText(shopAddr + "\n");
      pushText(shopTel + "\n");

      // æ¨™æº–ã«æˆ»ã™ï¼ˆã“ã“é‡è¦ï¼‰
      push(ESC, 0x21, 0x00);
      push(GS, 0x21, 0x00);

      // ä½æ‰€ãƒ»TEL ã¯æ™®é€šã‚µã‚¤ã‚º
      push(ESC, 0x21, 0x00);
      pushText(shopAddr + "\n");
      pushText(shopTel + "\n");
      pushText("--------------------------------\n");

      // ---------- ã‚¿ã‚¤ãƒˆãƒ«ï¼šãƒ¬ã‚·ãƒ¼ãƒˆ / RECEIPT ----------
      push(ESC, 0x61, 0x01);       // ä¸­å¤®
      // é«˜ã• 2 å€ + å¤ªå­—ï¼ˆå¹…ã¯æ™®é€šï¼‰ â†’ 0x10 + 0x08 = 0x18
      push(ESC, 0x21, 0x18);

      const titleStr =
        receiptData.receiptType === "formal"
          ? "FORMAL RECEIPT"
          : "RECEIPT";

      pushText(titleStr + "\n");

      // é€šå¸¸ãƒ•ã‚©ãƒ³ãƒˆã«æˆ»ã™
      push(ESC, 0x21, 0x00);
      pushText("--------------------------------\n");

      // ---------- æ—¥ä»˜ / REF / TABLE ----------
      const now  = receiptData.date ? new Date(receiptData.date) : new Date();
      const y    = now.getFullYear();
      const m    = String(now.getMonth() + 1).padStart(2, "0");
      const d    = String(now.getDate()).padStart(2, "0");
      const hh   = String(now.getHours()).padStart(2, "0");
      const mm   = String(now.getMinutes()).padStart(2, "0");
      const ss   = String(now.getSeconds()).padStart(2, "0");
      const dateStr = `${y}-${m}-${d}`;
      const timeStr = `${hh}:${mm}:${ss}`;

      push(ESC, 0x61, 0x00); // å·¦å¯„ã›

      pushText(makeTwoCol("DATE", `${dateStr} ${timeStr}`) + "\n");

      if (receiptData.referenceNumber) {
        pushText(makeTwoCol("REF", receiptData.referenceNumber) + "\n");
      }
      if (receiptData.table) {
        pushText(makeTwoCol("TABLE", String(receiptData.table)) + "\n");
      }

      pushText("--------------------------------\n");
      pushText("ITEMS\n");

      // ---------- å•†å“è¡Œï¼ˆAï¼šã‚ã‹ã‚Šã‚„ã™ã„å¼·èª¿å‹ / â‘¡ å·¦å³åˆ†é›¢ï¼‰ ----------
      const items = receiptData.items || receiptData.orders || [];
      items.forEach((item) => {
        const qty   = item.quantity || 1;
        const name  = escPosSafe(item.name || item.food || "");
        const price = Number(item.price || 0);
        const lineLeft  = `${qty}x ${name}`;
        const lineRight = price.toLocaleString(); // æ•°å­—ã ã‘

        pushText(makeTwoCol(lineLeft, lineRight) + "\n");
      });

      pushText("--------------------------------\n");

      // ---------- å°è¨ˆãƒ»å‰²å¼• ----------
      const subtotal = receiptData.subtotal || receiptData.originalTotal || 0;
      const discount = receiptData.discount || 0;
      const total    = receiptData.total || receiptData.finalTotal || subtotal;

      // å°è¨ˆï¼ˆæ™®é€šå¤ªã•ï¼‰
      push(ESC, 0x21, 0x00);
      pushText(makeTwoCol("SUBTOTAL", subtotal.toLocaleString()) + "\n");

      if (discount > 0) {
        const discStr = "-" + discount.toLocaleString();
        pushText(makeTwoCol("DISCOUNT", discStr) + "\n");
      }

      // ---------- åˆè¨ˆï¼ˆè¶…å¼·èª¿ï¼šå¤ªå­— + é«˜ã•2å€ï¼‰ ----------
      pushText("--------------------------------\n");
      // å·¦å³ 2 ã‚«ãƒ©ãƒ ã ãŒã€æ–‡å­—ã¯å°‘ã—å¤§ãã
      push(ESC, 0x21, 0x38); // å¤ªå­— + å››å€é«˜ã•ï¼ˆæ©Ÿç¨®ã«ã‚ˆã‚‹ãŒæœ€å¤§å¯„ã‚Šï¼‰
      pushText(makeTwoCol("TOTAL", total.toLocaleString()) + "\n");
      push(ESC, 0x21, 0x00); // æˆ»ã™

      pushText("--------------------------------\n");

      // ---------- æ”¯æ‰•æƒ…å ± ----------
      let pm = (receiptData.paymentMethod || "CASH").toUpperCase();
      pm = escPosSafe(pm);

      pushText(makeTwoCol("PAYMENT", pm) + "\n");

      //if (receiptData.paymentRef) {
      //  pushText(makeTwoCol("PAY REF", receiptData.paymentRef) + "\n");
      //}

      if (pm === "CASH" || pm === "MIXED") {
        if (receiptData.amountReceived) {
          pushText(
            makeTwoCol("RECEIVED", receiptData.amountReceived.toLocaleString()) + "\n"
          );
        }
        if (receiptData.change) {
          pushText(
            makeTwoCol("CHANGE", receiptData.change.toLocaleString()) + "\n"
          );
        }
      }

      // ---------- ãƒ•ãƒƒã‚¿ãƒ¼ ----------
      pushText("\n");
      push(ESC, 0x61, 0x01); // ä¸­å¤®å¯„ã›
      pushText("Thank you for dining with us.\n");
      pushText("Please come again.\n");

      // ä½™ç™½ & ã‚«ãƒƒãƒˆ
      pushText("\n\n\n");
      push(GS, 0x56, 0x41, 0x00); // å…¨åˆ‡ã‚Š

      return new Uint8Array(bytes);
    }


    function updateBluetoothButtonState() {
      const btn = document.getElementById('btnBluetooth');
      if (btn) {
        if (isBluetoothConnected) {
          btn.innerHTML = 'ğŸ“¡ Bluetooth Connected';
          btn.classList.add('primary');
          btn.classList.add('connected');
        } else {
          btn.innerHTML = 'ğŸ“¡ Connect Bluetooth';
          btn.classList.remove('primary');
          btn.classList.remove('connected');
        }
      }
    }

    function disconnectBluetoothPrinter() {
      if (bluetoothDevice && bluetoothDevice.gatt.connected) {
        bluetoothDevice.gatt.disconnect();
      }
      bluetoothDevice = null;
      bluetoothCharacteristic = null;
      isBluetoothConnected = false;
      updateBluetoothButtonState();
      showToast('Bluetooth disconnected', 'info');
    }

    async function autoPrintToBluetooth(receiptInfo) {
      const autoPrintEnabled = localStorage.getItem('bluetoothAutoPrint') === 'true';
      if (autoPrintEnabled && isBluetoothConnected) {
        return await printReceiptToBluetooth(receiptInfo);
      }
      return false;
    }

    function toggleBluetoothAutoPrint() {
      const current = localStorage.getItem('bluetoothAutoPrint') === 'true';
      const newValue = !current;
      localStorage.setItem('bluetoothAutoPrint', newValue);
      const btn = document.getElementById('btnAutoPrint');
      if (btn) {
        btn.innerHTML = newValue ? 'ğŸ”— Auto-Print ON' : 'ğŸ”— Auto-Print OFF';
        btn.classList.toggle('active', newValue);
        btn.classList.toggle('primary', newValue);
      }
      showToast(`Bluetooth auto-print ${newValue ? 'enabled' : 'disabled'}`, 'info');
      return newValue;
    }

    function initBluetoothSettings() {
      const autoPrintBtn = document.getElementById('btnAutoPrint');
      if (autoPrintBtn) {
        const isAutoPrint = localStorage.getItem('bluetoothAutoPrint') === 'true';
        autoPrintBtn.innerHTML = isAutoPrint ? 'ğŸ”— Auto-Print ON' : 'ğŸ”— Auto-Print OFF';
        autoPrintBtn.classList.toggle('active', isAutoPrint);
        autoPrintBtn.classList.toggle('primary', isAutoPrint);
      }
      updateBluetoothButtonState();
    }

    document.getElementById('btnBluetooth').addEventListener('click', async function() {
      if (isBluetoothConnected) {
        disconnectBluetoothPrinter();
      } else {
        await connectBluetoothPrinter();
      }
    });

    document.getElementById('btnAutoPrint').addEventListener('click', toggleBluetoothAutoPrint);

    // FIXED: applyCheckout function
    function applyCheckout(){
      const type=document.getElementById("co-discount-type").value;
      const value=Number(document.getElementById("co-discount-value").value)||0;
      const method=document.getElementById("co-method").value;
      const ref=document.getElementById("co-ref").value.trim();
      const finalTotal=Number(
        document.getElementById("co-final").textContent.replace(/,/g,"")
      )||0;
      const received=Number(document.getElementById("co-received").value)||0;
      const change=Number(
        document.getElementById("co-change").textContent.replace(/,/g,"")
      )||0;
      const receiptType=document.getElementById("co-receipt-type").value;
      const receiptName=document.getElementById("co-receipt-name").value.trim();

      if(finalTotal<=0){
        showToast("Final total must be greater than 0.","warning");return;
      }
      if((method==="cash" || method==="mixed") && received<finalTotal){
        const diff=finalTotal-received;
        showToast("Cash is short by "+formatCurrency(diff),"warning");return;
      }

      if(!window.google || !google.script || !google.script.run){
        console.error("google.script.run not available for checkout");
        showToast("Connection error - cannot apply payment","error");
        return;
      }

      let serverDiscountType="none";
      if(type==="percent") serverDiscountType="percent";
      else if(type==="fixed") serverDiscountType="yen";

      const payload={
        keys:checkoutState.orderIds,
        discountType:serverDiscountType,
        discountValue:value,
        staffName:currentStaff ? currentStaff.name : "",
        paymentMethod:method,
        paymentRef: ref || ""
      };

      google.script.run
        .withSuccessHandler(async function(res){
          if(!res || !res.success){
            showToast(res && res.message ? res.message : "Checkout failed","error");
            return;
          }

          showToast("Payment completed - Reference: " + res.referenceNumber,"success");

          // Update local order statuses
          allOrders.forEach(function(order) {
            if (checkoutState.orderIds.includes(order.key)) {
              order.status = "paid";
            }
          });

          const baseInfo={
            date:new Date(),
            table:checkoutState.orders[0] ? checkoutState.orders[0].table : "",
            orders:res.orderDetails || checkoutState.orders,
            originalTotal:res.summary ? res.summary.originalTotal : checkoutState.originalTotal,
            discountType:type,
            discountValue:value,
            finalTotal:res.summary ? res.summary.finalTotal : finalTotal,
            paymentMethod:method,
            paymentRef:ref,
            amountReceived:received,
            change:change,
            receiptType: receiptType,
            receiptName: receiptName || "",
            referenceNumber: res.referenceNumber,
            items: (res.orderDetails || checkoutState.orders).map(item => ({
              name: item.food || "",
              price: item.price || 0,
              quantity: 1
            }))
          };

          window.currentReceiptInfo = baseInfo;
          const bluetoothPrinted = await autoPrintToBluetooth(baseInfo);

          if (!bluetoothPrinted) {
            // Close modal and update UI
            closeCheckoutModal();
            selectedKeys.clear();

            const chkUnpaid = document.getElementById("chkUnpaid");
            const pillUnpaid = document.getElementById("pillUnpaidOnly");
            if (chkUnpaid) chkUnpaid.checked = false;
            if (pillUnpaid) pillUnpaid.classList.remove("active");

            render();
            loadData();

            // Show receipt for manual print
            const mode = receiptType === "formal" ? "formal" : "normal";
            const area = document.getElementById("receiptArea");
            area.innerHTML = `
              <button class="receipt-close-btn" onclick="closeReceipt()">Ã— Close</button>
              <button class="receipt-print-btn" onclick="printReceiptBrowser()">ğŸ–¨ Print</button>
              ${isBluetoothConnected ? '<button class="receipt-bluetooth-btn" onclick="printCurrentReceiptToBluetooth()">ğŸ–¨ï¸ Bluetooth Print</button>' : ''}
              <div id="receiptContainer"></div>
            `;
            area.style.display = "block";
            buildReceiptHtml(mode, baseInfo);
            
          } else {
            // Bluetooth printed successfully
            closeCheckoutModal();
            selectedKeys.clear();
            const chkUnpaid = document.getElementById("chkUnpaid");
            const pillUnpaid = document.getElementById("pillUnpaidOnly");
            if (chkUnpaid) chkUnpaid.checked = false;
            if (pillUnpaid) pillUnpaid.classList.remove("active");
            render();
            loadData();
          }

        })
        .withFailureHandler(function(error) {
          showToast("Checkout failed: " + error.message, "error");
        })
        .checkoutOrders(payload);
    }

    function buildReceiptHtml(mode, info, append) { 
      const area = document.getElementById("receiptArea");
      if (!area) return;

      const isAppend = !!append;
      
      if (!isAppend) {
        const container = area.querySelector("#receiptContainer") || area;
        container.innerHTML = "";
        window.currentReceiptInfo = info;
      }
      
      const container = document.getElementById("receiptContainer") || area;
      const d = info.date instanceof Date ? info.date : new Date(info.date || Date.now());
      const dateStr = fmtDateISO(d);
      const timeStr = fmtTime(d);
      const shopName = CONFIG.receipt.shopName;
      const shopAddr = CONFIG.receipt.shopAddr;
      const shopTel  = CONFIG.receipt.shopTel;
      let html = "";

      if (mode === "formal") {
        const recipientName = info.receiptName || "____________________________";
        html =
          '<div class="receipt-box">' +
            '<div class="receipt-header">' +
              '<div class="shop-name">' + shopName + '</div>' +
              '<div class="shop-sub">' + shopAddr + '</div>' +
              '<div class="shop-sub">' + shopTel + '</div>' +
            '</div>' +
            '<div class="receipt-title">é ˜åæ›¸ / FORMAL RECEIPT</div>' +
            '<div class="formal-block">' +
              '<div style="margin-bottom:4mm;">å®›åï¼š' + recipientName + ' æ§˜</div>' +
              '<div>ä½†ã—ã€€ãŠé£Ÿäº‹ä»£ã¨ã—ã¦</div>' +
              '<div class="formal-amount">é‡‘é¡ï¼š' + formatCurrency(info.finalTotal || 0) + '-</div>' +
            '</div>' +
            '<div class="receipt-row" style="margin-top:4mm;">' +
              '<span>æ—¥ä»˜ / Date</span>' +
              '<span>' + dateStr + ' ' + timeStr + '</span>' +
            '</div>' +
            (info.referenceNumber ?
              '<div class="receipt-row"><span>Reference No.</span><span style="font-family:monospace; font-weight:600;">' +
              info.referenceNumber + '</span></div>' : '') +
            '<div class="receipt-row"><span>ãŠæ”¯æ‰•ã„æ–¹æ³•</span><span>' +
              String(info.paymentMethod || "").toUpperCase() + '</span></div>' +
            '<div class="formal-stamp">' + shopName + '<br/>ï¼ˆå°ï¼‰</div>' +
            '<div class="receipt-footer" style="margin-top:6mm;">â€»ã“ã®é ˜åæ›¸ã¯å†ç™ºè¡Œã§ãã¾ã›ã‚“ã€‚å¤§åˆ‡ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</div>' +
          '</div>';
        container.insertAdjacentHTML("beforeend", html);
        return;
      }

      if (mode === "normal-summary") {
        html =
          '<div class="receipt-box">' +
            '<div class="receipt-header">' +
              '<div class="shop-name">' + shopName + '</div>' +
              '<div class="shop-sub">' + shopAddr + '</div>' +
              '<div class="shop-sub">' + shopTel + '</div>' +
            '</div>' +
            '<div class="receipt-title">Daily Summary</div>' +
            '<div class="receipt-row"><span>Date</span><span>' +
              fmtDateISO(info.date || new Date()) + '</span></div>' +
            '<div class="receipt-row total"><span>Total</span><span>' +
              (info.total || "") + '</span></div>' +
          '</div>';
        container.insertAdjacentHTML("beforeend", html);
        return;
      }

      const ordersArr = info.orders || [];
      let itemsHtml = "";
      for (let i = 0; i < ordersArr.length; i++) {
        const o = ordersArr[i];
        const name = o.food || "";
        const price = Number(o.price || o.finalPrice || 0);
        itemsHtml +=
          '<div class="receipt-item-line">' +
            '<span class="receipt-item-line-name">' + name + '</span>' +
            '<span>' + price.toLocaleString() + '&nbsp;å††</span>' +
          '</div>';
      }
      if (!itemsHtml) {
        itemsHtml =
          '<div class="receipt-item-line"><span>No items</span><span></span></div>';
      }

      let discountLabel = "";
      const originalTotalNum = Number(info.originalTotal || 0);
      const finalTotalNum   = Number(info.finalTotal || originalTotalNum);
      const explicitDiscount = Number(info.discount || 0);

      if (info.discountType === "percent" && info.discountValue > 0) {
        const discountAmount = Math.round(
          originalTotalNum * (Number(info.discountValue) / 100)
        );
        discountLabel =
          "å‰²å¼• (" + info.discountValue + "%): -" +
          discountAmount.toLocaleString() + "å††";
      } else if (info.discountType === "fixed" && info.discountValue > 0) {
        discountLabel =
          "å‰²å¼•: -" + Number(info.discountValue).toLocaleString() + "å††";
      } else if (!info.discountType && explicitDiscount > 0) {
        discountLabel =
          "å‰²å¼•: -" + explicitDiscount.toLocaleString() + "å††";
      }

      html =
        '<div class="receipt-box">' +
          '<div class="receipt-header">' +
            '<div class="shop-name">' + shopName + '</div>' +
            '<div class="shop-sub">' + shopAddr + '</div>' +
            '<div class="shop-sub">' + shopTel + '</div>' +
          '</div>' +
          '<div class="receipt-title">ãƒ¬ã‚·ãƒ¼ãƒˆ / RECEIPT</div>' +
          (info.referenceNumber ?
            '<div class="reference-number-display">' +
              '<div class="reference-number-label">REFERENCE NUMBER</div>' +
              '<div class="reference-number-value">' + info.referenceNumber + '</div>' +
            '</div>' : '') +
          '<div class="receipt-row"><span>æ—¥æ™‚</span><span>' +
            dateStr + ' ' + timeStr + '</span></div>' +
          '<div class="receipt-row"><span>Table</span><span>' +
            (info.table || '-') + '</span></div>' +
          '<div class="receipt-items">' + itemsHtml + '</div>' +
          '<div class="receipt-row"><span>å°è¨ˆ</span><span>' +
            originalTotalNum.toLocaleString() + 'å††</span></div>' +
          (discountLabel ?
            '<div class="receipt-row"><span>' + discountLabel +
            '</span><span></span></div>' : "") +
          '<div class="receipt-row total"><span>åˆè¨ˆ</span><span>' +
            finalTotalNum.toLocaleString() + 'å††</span></div>' +
          '<div class="receipt-row"><span>æ”¯æ‰•æ–¹æ³•</span><span>' +
            String(info.paymentMethod || "").toUpperCase() + '</span></div>' +
          //(info.paymentRef ?
           // '<div class="receipt-row"><span>Ref</span><span>' +
           //   info.paymentRef + '</span></div>' : "") +
          '<div class="receipt-row"><span>ãŠé ã‹ã‚Š</span><span>' +
            Number(info.amountReceived || 0).toLocaleString() + 'å††</span></div>' +
          '<div class="receipt-row"><span>ãŠé‡£ã‚Š</span><span>' +
            Number(info.change || 0).toLocaleString() + 'å††</span></div>' +
          '<div class="receipt-footer">Thank you for dining with us.<br/>ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</div>' +
        '</div>';

      container.insertAdjacentHTML("beforeend", html);
    }

    function printCurrentReceiptToBluetooth() {
      if (!window.currentReceiptInfo) {
        showToast('No receipt data available', 'error');
        return;
      }
      if (!isBluetoothConnected) {
        showToast('Bluetooth printer not connected', 'error');
        return;
      }
      printReceiptToBluetooth(window.currentReceiptInfo);
    }

    function runTestPrint(){
      if(!window.google || !google.script || !google.script.run){
        showToast("Cannot connect to server for test print","error");
        return;
      }
      google.script.run
        .withSuccessHandler(function(res){
          if(res && res.success){
            showToast("Test print sent. Check printer.","success");
          }else{
            showToast((res && res.message) || "Test print done (check printer/app)","info");
          }
        })
        .withFailureHandler(function(err){
          showToast("Test print error: "+err.message,"error");
        })
        .testPrint();
    }

    document.getElementById("co-receipt-type").addEventListener("change",function(){
      const receiptNameField=document.getElementById("co-receipt-name");
      if(this.value==="formal"){
        receiptNameField.style.display="block";
        receiptNameField.placeholder="Enter company/name for receipt";
      }else{
        receiptNameField.style.display="none";
        receiptNameField.value="";
      }
    });

    /******************************************************
     * ENHANCED REPRINT SYSTEM WITH REFERENCE NUMBERS
     ******************************************************/
    document.getElementById("btnReprint").addEventListener("click", function() {
      openReprintModal();
    });

    function openReprintModal() {
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      document.getElementById("reprint-start-date").value = fmtDateISO(yesterday);
      document.getElementById("reprint-end-date").value = fmtDateISO(today);
      document.getElementById("reprint-search-date").value = fmtDateISO(today);
      document.getElementById("reprint-search-term").value = "";
      document.getElementById("reprint-search-term").placeholder = "Enter reference number (e.g., 251129-0001)";
      document.getElementById("reprint-receipt-name").value = "";
      document.getElementById("reprint-receipt-type").value = "normal";
      document.getElementById("reprint-unpaid-only").checked = false;
      document.getElementById("reprint-results").style.display = "none";
      document.getElementById("btn-print-selected").style.display = "none";
      reprintState.selectedOrders.clear();
      reprintState.currentOrders = [];
      document.getElementById("reprint-backdrop").classList.remove("hidden");
      document.getElementById("reprint-modal").classList.remove("hidden");
      setTimeout(() => {
        document.getElementById("reprint-search-term").focus();
      }, 300);
    }

    function closeReprintModal() {
      document.getElementById("reprint-backdrop").classList.add("hidden");
      document.getElementById("reprint-modal").classList.add("hidden");
    }

    document.getElementById("reprint-search-type").addEventListener("change", function() {
      const searchType = this.value;
      document.getElementById("reprint-date-search").style.display =
         (searchType === "date") ? "block" : "none";
      document.getElementById("reprint-text-search").style.display =
         (searchType === "search") ? "block" : "none";
      document.getElementById("reprint-results").style.display = "none";
      document.getElementById("btn-print-selected").style.display = "none";
      reprintState.selectedOrders.clear();
    });

    function searchReprintOrders() {
      const searchType = document.getElementById("reprint-search-type").value;
      const loadingEl = document.getElementById("reprint-loading");
      loadingEl.style.display = "inline-block";
      reprintState.selectedOrders.clear();
      document.getElementById("btn-print-selected").style.display = "none";
      document.getElementById("reprint-results").style.display = "none";

      if (searchType === "date") {
        const startDate = document.getElementById("reprint-start-date").value;
        const endDate = document.getElementById("reprint-end-date").value;
        if (!startDate || !endDate) {
          showToast("Please select both start and end dates", "warning");
          loadingEl.style.display = "none";
          return;
        }
        google.script.run
          .withSuccessHandler(function(res) {
            loadingEl.style.display = "none";
            handleReprintResults(res);
          })
          .withFailureHandler(function(err) {
            loadingEl.style.display = "none";
            showToast("Search error: " + err.message, "error");
          })
          .getOrdersForReprint(startDate, endDate);
      } else {
        const searchTerm = document.getElementById("reprint-search-term").value.trim();
        if (!searchTerm) {
          showToast("Please enter search term (reference number, table, or food)", "warning");
          loadingEl.style.display = "none";
          return;
        }
        const searchDate = document.getElementById("reprint-search-date").value;
        if (isReferenceNumber(searchTerm)) {
          google.script.run
            .withSuccessHandler(function(res) {
              loadingEl.style.display = "none";
              handleReprintResults(res);
            })
            .withFailureHandler(function(err) {
              loadingEl.style.display = "none";
              showToast("Search error: " + err.message, "error");
            })
            .searchByReferenceNumber(searchTerm);
        } else {
          google.script.run
            .withSuccessHandler(function(res) {
              loadingEl.style.display = "none";
              handleReprintResults(res);
            })
            .withFailureHandler(function(err) {
              loadingEl.style.display = "none";
              showToast("Search error: " + err.message, "error");
            })
            .searchOrdersForReprint(searchTerm, searchDate || "");
        }
      }
    }

    function isReferenceNumber(str) {
      const refPattern = /^\d{6}-\d{4}$/;
      return refPattern.test(str);
    }

    function handleReprintResults(res) {
      const resultsDiv = document.getElementById("reprint-results");
      if (!res || !res.success) {
        showToast(res?.message || "Search failed", "error");
        resultsDiv.style.display = "none";
        return;
      }
      reprintState.currentOrders = res.orders || [];
      if (reprintState.currentOrders.length === 0) {
        showToast("No orders found", "warning");
        resultsDiv.style.display = "none";
        return;
      }
      document.getElementById("reprint-results-count").textContent = reprintState.currentOrders.length;
      displayReprintOrders(reprintState.currentOrders);
      resultsDiv.style.display = "block";
    }

    function displayReprintOrders(orders) {
      const container = document.getElementById("reprint-orders-list");
      container.innerHTML = "";
      if (orders.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #9ca3af;">
            No orders found. Try searching by reference number, table number, or date range.
          </div>
        `;
        return;
      }
      orders.sort((a, b) => {
        const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
        const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
        return dateB - dateA;
      });
      orders.forEach((order, index) => {
        const orderDate = order.timestamp ? new Date(order.timestamp) : new Date();
        const timeStr = fmtTime(orderDate);
        const dateStr = fmtDateISO(orderDate);
        const isPaid = String(order.status || '').toLowerCase() === 'paid';
        const orderId = `reprint-order-${index}`;
        const orderEl = document.createElement("div");
        orderEl.className = `reprint-order-item ${isPaid ? '' : 'unpaid'}`;
        orderEl.id = orderId;
        orderEl.innerHTML = `
          <div style="display: flex; align-items: flex-start;">
            <input type="checkbox" class="reprint-checkbox"
                    ${isPaid ? '' : 'disabled'}
                    id="checkbox-${orderId}"
                   style="margin-right: 12px; margin-top: 2px;">
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                <div>
                  <div style="font-weight: 600; font-size: 14px; color: #f9fafb;">
                    Table: ${order.table || "No Table"}
                  </div>
                  <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                    ${dateStr} ${timeStr}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: 600; font-size: 16px; color: #10b981;">
                    Â¥${Number(order.finalPrice || order.originalPrice || 0).toLocaleString()}
                  </div>
                  <div class="status-pill ${isPaid ? 'status-paid' : 'status-unpaid'}" style="margin-top: 4px; display: inline-block;">
                    ${isPaid ? 'PAID' : 'UNPAID'}
                  </div>
                </div>
              </div>
              ${order.referenceNumber ? `
              <div style="background: #1e3a8a; border: 1px solid #3b82f6; border-radius: 6px; padding: 8px; margin: 8px 0;">
                <div style="font-size: 11px; color: #bfdbfe; margin-bottom: 2px;">REFERENCE NUMBER</div>
                <div style="font-family: monospace; font-size: 14px; font-weight: 600; color: #fff;">
                  ${order.referenceNumber}
                </div>
              </div>
              ` : '' }
              <div style="font-size: 13px; color: #d1d5db; margin-bottom: 4px;">
                ${order.food || "No items listed"}
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 11px; color: #9ca3af;">
                <span>Payment: ${order.paymentMethod || "Cash"}</span>
                ${(order.discount || 0) > 0 ?
                   `<span>Discount: -Â¥${Number(order.discount).toLocaleString()}</span>` : '' }
              </div>
              ${!isPaid ? `
              <div style="font-size: 11px; color: #ef4444; margin-top: 6px; padding: 4px; background: #7f1d1d20; border-radius: 4px;">
                âš  æœªæ‰•ã„ã®ãŸã‚å†ç™ºè¡Œã§ãã¾ã›ã‚“
              </div>
              ` : '' }
            </div>
          </div>
        `;
        const checkbox = orderEl.querySelector('.reprint-checkbox');
        if (checkbox && isPaid) {
          checkbox.addEventListener('change', function() {
            const id = this.id.replace('checkbox-', '');
            if (this.checked) {
              reprintState.selectedOrders.add(id);
              orderEl.classList.add('selected');
            } else {
              reprintState.selectedOrders.delete(id);
              orderEl.classList.remove('selected');
            }
            updateReprintButtonState();
          });
        }
        orderEl.dataset.orderData = JSON.stringify(order);
        container.appendChild(orderEl);
      });
      updateReprintButtonState();
    }

    function updateReprintButtonState() {
      const printBtn = document.getElementById('btn-print-selected');
      if (reprintState.selectedOrders.size > 0) {
        printBtn.style.display = 'inline-block';
        printBtn.textContent = `Print Selected (${reprintState.selectedOrders.size})`;
      } else {
        printBtn.style.display = 'none';
      }
    }

    function printSelectedReprint() {
      if (reprintState.selectedOrders.size === 0) {
        showToast("Please select orders to print", "warning");document.getElemen
        return;
      }
      const receiptType = document.getElementById("reprint-receipt-type").value;
      const receiptName = document.getElementById("reprint-receipt-name").value.trim();
      const selectedOrders = [];
      reprintState.selectedOrders.forEach(orderId => {
        const orderEl = document.getElementById(orderId);
        if (orderEl) {
          const orderData = JSON.parse(orderEl.dataset.orderData || '{}');
          selectedOrders.push(orderData);
        }
      });
      if (selectedOrders.length === 0) {
        showToast("No valid orders selected", "warning");
        return;
      }
      const area = document.getElementById("receiptArea");
      area.innerHTML = `
        <button class="receipt-close-btn" onclick="closeReceipt()">Ã— Close</button>
        <button class="receipt-print-btn" onclick="printReceiptBrowser()">ğŸ–¨ Print All</button>
        ${isBluetoothConnected ? '<button class="receipt-bluetooth-btn" onclick="printCurrentReceiptToBluetooth()">ğŸ–¨ï¸ Bluetooth Print</button>' : ''}
        <div id="receiptContainer"></div>
      `;
      area.style.display = "block";
      
      selectedOrders.forEach((order, index) => {
        const orderDate = order.timestamp ? new Date(order.timestamp) : new Date();
        const baseInfo = {
          date: orderDate,
          table: order.table || "",
          orders: [{
            food: order.food || "",
            price: order.finalPrice || order.originalPrice || 0,
            originalPrice: order.originalPrice || order.finalPrice || 0,
            discount: order.discount || 0
          }],
          originalTotal: order.originalPrice || order.finalPrice || 0,
          discountType: (order.discount || 0) > 0 ? "fixed" : "none",
          discountValue: order.discount || 0,
          finalTotal: order.finalPrice || order.originalPrice || 0,
          paymentMethod: order.paymentMethod || "cash",
          paymentRef: order.paymentRef || "",
          amountReceived: order.finalPrice || order.originalPrice || 0,
          change: 0,
          receiptType: receiptType,
          receiptName: receiptName || "",
          referenceNumber: order.referenceNumber || "",
          discount: order.discount || 0
        };
        
        if (receiptType === "formal") {
          buildReceiptHtml("formal", baseInfo, true);
        } else {
          buildReceiptHtml("normal", baseInfo, true);
        }
      });
      
      showToast(`Receipt for ${selectedOrders.length} order(s) ready for printing`, "success");
      
      // Auto-print after a short delay
      setTimeout(() => {
        printReceiptBrowser();
      }, 500);
    }

    // Initialize on load
    window.addEventListener('load', function() {
      initBluetoothSettings();
      if (!isWebBluetoothAvailable()) {
        console.warn('Web Bluetooth API not available');
        const bluetoothBtn = document.getElementById('btnBluetooth');
        if (bluetoothBtn) {
          bluetoothBtn.disabled = true;
          bluetoothBtn.innerHTML = 'ğŸ“¡ Bluetooth Not Supported';
          bluetoothBtn.title = 'Web Bluetooth API not available in this browser';
        }
        const autoPrintBtn = document.getElementById('btnAutoPrint');
        if (autoPrintBtn) {
          autoPrintBtn.disabled = true;
          autoPrintBtn.title = 'Bluetooth not supported';
        }
      }
    });

    const loginOverlay = document.getElementById("loginOverlay");
    if (loginOverlay) {
      loginOverlay.style.display = "flex";
    }

    const datePicker = document.getElementById("datePicker");
    if (datePicker) {
      datePicker.value = fmtDateISO(new Date());
    }

      /**
   * å…¨ç”»é¢å…±é€šï¼šæ¨ªå‘ããƒ­ãƒƒã‚¯ + URLãƒãƒ¼éè¡¨ç¤ºã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã£ã½ãã™ã‚‹
   */
  (function () {
    function lockLandscape() {
      // å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã ã‘å®Ÿè¡Œï¼ˆéå¯¾å¿œãªã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('landscape').catch(function () {
          // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆiOS ã‚„ PC ãªã©ï¼‰
        });
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('load', function () {
      // æ¨ªå‘ããƒ­ãƒƒã‚¯è©¦è¡Œ
      lockLandscape();

      // Android ã§ URL ãƒãƒ¼ã‚’éš ã—ã¦ã€ã‚ˆã‚Šãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«è¿‘ã¥ã‘ã‚‹
      setTimeout(function () {
        window.scrollTo(0, 1);
      }, 200);
    });

    // ç«¯æœ«ã®å‘ããŒå¤‰ã‚ã£ãŸæ™‚ã‚‚ã€ã‚‚ã†ä¸€åº¦ãƒ­ãƒƒã‚¯ã‚’è©¦ã™
    window.addEventListener('orientationchange', function () {
      lockLandscape();
    });
  })();


</script>
</body>
</html>
